<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ph·∫ßn m·ªÅm ƒëi·ªÉm danh h·ªçc sinh (C·ªông t√°c)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* General styling for the entire page */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px; /* Reduced padding for mobile */
        }

        /* Main container for the application */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* Header section */
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px; /* Adjusted padding */
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2rem; /* Adjusted font size */
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1rem; /* Adjusted font size */
            opacity: 0.9;
        }
        
        #app-id-container {
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-top: 15px;
            display: inline-block;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        #app-id-container span {
            font-weight: bold;
            color: #fff;
        }


        /* Tab navigation */
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            flex-wrap: wrap; /* Allow tabs to wrap on small screens */
        }

        .tab {
            flex: 1 1 auto; /* Allow tabs to grow and shrink */
            padding: 15px 10px; /* Adjusted padding */
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem; /* Adjusted font size */
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
            text-align: center;
        }

        .tab.active {
            background: white;
            color: #4facfe;
            border-bottom: 3px solid #4facfe;
        }

        .tab:hover:not(.active) {
            background: #e9ecef;
            color: #495057;
        }

        /* Content for each tab */
        .tab-content {
            display: none;
            padding: 20px; /* Adjusted padding */
        }

        .tab-content.active {
            display: block;
        }

        /* Styling for form sections */
        .form-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px; /* Adjusted padding */
            margin-bottom: 25px;
            border-left: 4px solid #4facfe;
        }

        .form-section h3 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Adjusted minmax */
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
            width: 100%; /* Ensure full width */
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        /* General button styling */
        .btn {
            padding: 12px 20px; /* Adjusted padding */
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center; /* Center content */
            gap: 8px;
            width: 100%; /* Make buttons full width on mobile */
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }


        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
        }
        
        /* Student list styling */
        .student-list {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .student-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 15px 20px;
        }
        
        .student-list-header h3 {
            margin: 0;
            font-size: 1.3rem;
        }
        
        .student-list-header .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .student-list-header .header-controls label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            cursor: pointer;
        }


        .student-item {
            padding: 15px; /* Adjusted padding */
            border-bottom: 1px solid #e9ecef;
            display: grid;
            grid-template-columns: auto 1fr; /* Checkbox and content */
            gap: 15px; 
            align-items: center;
            transition: all 0.3s ease;
        }

        .student-item:hover {
            background: #f8f9fa;
        }
        
        .student-item-content {
            display: grid;
            grid-template-columns: 1fr; /* Single column layout for mobile */
            gap: 15px; /* Gap between info and controls */
            align-items: center;
        }

        .student-info {
            display: grid;
            grid-template-columns: 1fr; /* Single column for details */
            gap: 10px; /* Adjusted gap */
        }
        
        .student-detail {
            display: flex;
            flex-direction: column;
        }

        .student-detail strong {
            color: #495057;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .student-detail span {
            color: #6c757d;
            font-size: 1rem;
        }

        /* Attendance controls and status styling */
        .attendance-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center; /* Center buttons on mobile */
        }
        
        .attendance-controls .btn {
            flex: 1 1 100px; /* Allow buttons to grow and shrink */
        }


        .attendance-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            border: 2px solid transparent;
        }

        .status-present { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .status-late { background: #fff3cd; color: #856404; border-color: #ffeaa7; }
        .status-absent-unexcused { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .status-absent-excused { background: #e2e3e5; color: #383d41; border-color: #d6d8db; }

        /* Quick actions bar */
        .quick-actions {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .quick-actions .btn {
             flex: 1 1 150px; /* Responsive buttons */
        }

        /* Statistics grid and cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); /* Adjusted minmax */
            gap: 15px; /* Adjusted gap */
            margin-bottom: 25px;
        }

        .stats-card {
            background: white;
            border-radius: 10px;
            padding: 20px; /* Adjusted padding */
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #4facfe;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stats-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.15); }
        .stats-card.active-filter { border-left-width: 6px; border-left-color: #007bff; box-shadow: 0 0 15px rgba(0, 123, 255, 0.3); transform: translateY(-2px); }
        .stats-card h4 { color: #495057; margin-bottom: 10px; font-size: 0.9rem; } /* Adjusted font size */
        .stats-card .number { font-size: 2rem; font-weight: bold; color: #4facfe; margin-bottom: 5px; } /* Adjusted font size */
        .stats-card .label { color: #6c757d; font-size: 0.9rem; }

        /* Date filter section */
        .date-filter { background: white; border-radius: 10px; padding: 20px; margin-bottom: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .filter-row { display: grid; grid-template-columns: 1fr; gap: 15px; align-items: end; } /* Single column by default */
        
        /* Empty state for lists */
        .empty-state { text-align: center; padding: 60px 20px; color: #6c757d; }
        .empty-state i { font-size: 4rem; margin-bottom: 20px; opacity: 0.3; }
        .empty-state h3 { margin-bottom: 10px; color: #495057; }
        
        /* --- Desktop and Tablet Styles --- */
        @media (min-width: 768px) {
             body {
                padding: 20px; /* Restore padding for larger screens */
            }
            .header h1 {
                font-size: 2.5rem; /* Restore font size */
            }
             .header p {
                font-size: 1.1rem; /* Restore font size */
            }
            .tab {
                font-size: 1rem; /* Restore font size */
                 padding: 15px 20px; /* Restore padding */
            }
            .tab-content, .form-section {
                 padding: 30px; /* Restore padding */
            }
            .btn {
                width: auto; /* Buttons are not full width on desktop */
            }
            .filter-row {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Multi-column layout */
            }
            .student-item-content {
                 grid-template-columns: 1fr auto; /* Two columns for info and controls */
                 gap: 20px;
            }
            .student-info {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Responsive grid for info */
                gap: 15px;
            }
             .attendance-controls {
                justify-content: flex-end; /* Align buttons to the right */
            }
            .attendance-controls .btn {
                 flex-grow: 0; /* Prevent buttons from growing too large */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Ph·∫ßn m·ªÅm ƒëi·ªÉm danh h·ªçc sinh</h1>
            <p>C·ªông t√°c ƒëi·ªÉm danh th·ªùi gian th·ª±c</p>
            <div id="app-id-container">
                M√£ chia s·∫ª (App ID): <span id="appIdDisplay">ƒêang t·∫£i...</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('students')">üë• Qu·∫£n l√Ω h·ªçc sinh</button>
            <button class="tab" onclick="showTab('attendance')">üìù ƒêi·ªÉm danh</button>
            <button class="tab" onclick="showTab('daily-stats')">üìä Th·ªëng k√™ h√†ng ng√†y</button>
            <button class="tab" onclick="showTab('monthly-stats')">üìà Th·ªëng k√™ h√†ng th√°ng</button>
        </div>

        <div id="students" class="tab-content active">
            <div class="form-section">
                <h3>üìÅ Nh·∫≠p danh s√°ch t·ª´ Excel</h3>
                <div class="form-row">
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Ch·ªçn file Excel (*.xlsx, *.xls)</label>
                        <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="handleExcelUpload(event)">
                        <small style="color: #6c757d; margin-top: 5px; display: block;">
                            üìã File Excel c·∫ßn c√≥ c√°c c·ªôt: <strong>H·ªç v√† t√™n, L·ªõp, Ng√†y sinh, Gi·ªõi t√≠nh, Lo·∫°i h·ªçc sinh</strong>
                        </small>
                    </div>
                </div>
                <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                    <button class="btn btn-success" onclick="importStudentsFromExcel()">
                        üì• Nh·∫≠p t·ª´ Excel
                    </button>
                    <button class="btn btn-info" onclick="downloadExcelTemplate()">
                        üìÑ T·∫£i m·∫´u Excel
                    </button>
                    <span id="importStatus" style="color: #28a745; font-weight: bold;"></span>
                </div>
            </div>

            <div class="form-section">
                <h3>‚ûï Th√™m h·ªçc sinh m·ªõi</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>H·ªç v√† t√™n</label>
                        <input type="text" id="studentName" placeholder="Nh·∫≠p h·ªç v√† t√™n h·ªçc sinh">
                    </div>
                    <div class="form-group">
                        <label>L·ªõp</label>
                        <input type="text" id="studentClass" placeholder="V√≠ d·ª•: 6A1">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ng√†y sinh</label>
                        <input type="date" id="studentBirthDate">
                    </div>
                    <div class="form-group">
                        <label>Gi·ªõi t√≠nh</label>
                        <select id="studentGender">
                            <option value="">-- Ch·ªçn gi·ªõi t√≠nh --</option>
                            <option value="Nam">Nam</option>
                            <option value="N·ªØ">N·ªØ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Lo·∫°i h·ªçc sinh</label>
                        <select id="studentType">
                            <option value="">-- Ch·ªçn lo·∫°i --</option>
                            <option value="B√°n tr√∫">B√°n tr√∫</option>
                            <option value="Kh√¥ng b√°n tr√∫">Kh√¥ng b√°n tr√∫</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addStudent()">‚ûï Th√™m h·ªçc sinh</button>
            </div>

            <div class="student-list">
                <div class="student-list-header">
                    <h3>üìã Danh s√°ch h·ªçc sinh</h3>
                    <div class="header-controls">
                        <label>
                            <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this.checked)" style="transform: scale(1.5);">
                            Ch·ªçn t·∫•t c·∫£
                        </label>
                        <button class="btn btn-danger" style="width: auto; padding: 8px 15px;" onclick="deleteSelectedStudents()">üóëÔ∏è X√≥a ƒë√£ ch·ªçn</button>
                    </div>
                </div>
                <div id="studentsList"></div>
            </div>
        </div>

        <div id="attendance" class="tab-content">
            <div class="quick-actions">
                <button class="btn btn-success" onclick="markAllPresent()">‚úÖ T·∫•t c·∫£ c√≥ m·∫∑t</button>
                <button class="btn btn-info" onclick="exportAttendanceToExcel()">üìÅ Xu·∫•t Excel</button>
                <button class="btn" style="background: #6c757d; color: white;" onclick="showSaveLog()">üìã Nh·∫≠t k√Ω l∆∞u</button>
            </div>

            <div class="date-filter">
                <h4>üìÖ L·ªçc v√† ƒëi·ªÉm danh</h4>
                <div class="filter-row">
                    <div class="form-group">
                        <label for="attendanceDate">Ch·ªçn ng√†y ƒëi·ªÉm danh</label>
                        <input type="date" id="attendanceDate" onchange="loadAttendanceForDate()">
                    </div>
                    <div class="form-group">
                        <label for="classFilter">Ch·ªçn l·ªõp</label>
                        <select id="classFilter" onchange="loadAttendanceForDate()"></select>
                    </div>
                </div>
            </div>

            <div class="student-list">
                <h3 id="attendanceListTitle">üë®‚Äçüéì ƒêi·ªÉm danh h·ªçc sinh</h3>
                <div id="attendanceList"></div>
            </div>
        </div>

        <div id="daily-stats" class="tab-content">
            <div class="date-filter">
                <div class="filter-row">
                    <div class="form-group">
                        <label>Ch·ªçn ng√†y th·ªëng k√™</label>
                        <input type="date" id="dailyStatsDate" onchange="loadDailyStats()">
                    </div>
                    <div class="form-group">
                        <label for="dailyStatsClassFilter">Ch·ªçn l·ªõp</label>
                        <select id="dailyStatsClassFilter" onchange="loadDailyStats()"></select>
                    </div>
                    <div class="form-group">
                         <button class="btn btn-info" onclick="loadDailyStats()">üìä Xem th·ªëng k√™</button>
                    </div>
                     <div class="form-group">
                        <button class="btn btn-success" onclick="exportDailyStatsToExcel()">üìÅ Xu·∫•t Excel</button>
                    </div>
                </div>
            </div>

            <div class="stats-grid" id="dailyStatsGrid"></div>
            <div class="student-list" id="dailyStatsList"></div>
        </div>

        <div id="monthly-stats" class="tab-content">
            <div class="date-filter">
                <div class="filter-row">
                    <div class="form-group">
                        <label>Ch·ªçn th√°ng/nƒÉm</label>
                        <input type="month" id="monthlyStatsDate" onchange="loadMonthlyStats()">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-info" onclick="loadMonthlyStats()">üìà Xem th·ªëng k√™</button>
                    </div>
                     <div class="form-group">
                        <button class="btn btn-success" onclick="exportMonthlyStatsToExcel()">üìÅ Xu·∫•t Excel</button>
                    </div>
                </div>
            </div>

            <div class="stats-grid" id="monthlyStatsGrid"></div>
            <div class="student-list" id="monthlyStatsList"></div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- GLOBAL VARIABLES ---
        const appId = 'diem-danh-NTTo';
        const firebaseConfig = {
    		apiKey: "AIzaSyBbNvKLgj8QdM22rqxnS65cJGSF5wNUIJE",
    		authDomain: "diem-danh-20xx.firebaseapp.com",
    		projectId: "diem-danh-20xx",
    		storageBucket: "diem-danh-20xx.firebasestorage.app",
    		messagingSenderId: "474588160188",
    		appId: "1:474588160188:web:37a1b187369ff47e56f0b9",
    		measurementId: "G-CYHW7NZKGM"
  		};
        
        let db;
        let auth;
        let dataDocRef;

        // --- DATA MANAGEMENT ---
        window.students = [];
        window.attendanceRecords = {};
        window.excelData = [];

        // --- FIREBASE INITIALIZATION ---
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            document.getElementById('appIdDisplay').textContent = appId;
        } catch (e) {
            console.error("Error initializing Firebase:", e);
            alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn c∆° s·ªü d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.");
        }

        // --- ASYNC AUTH & DATA LISTENER SETUP ---
        async function initializeFirebase() {
            try {
                // Step 1: Authenticate user
                await signInAnonymously(auth);
				console.log("Signed in anonymously.");

                const user = auth.currentUser;
                if (!user) {
                    throw new Error("Authentication failed, user is null.");
                }

                // Step 2: Set up Firestore listener AFTER successful authentication
                dataDocRef = doc(db, "artifacts", appId, "public", "data", "attendance", "mainDoc");

                onSnapshot(dataDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        window.students = data.students || [];
                        window.attendanceRecords = data.attendanceRecords || {};
                    } else {
                        // Initialize with sample data if document doesn't exist
                        window.students = [
                            { id: 1, name: "Nguy·ªÖn VƒÉn An", class: "6A1", birthDate: "2011-03-15", gender: "Nam", type: "B√°n tr√∫" },
                            { id: 2, name: "Tr·∫ßn Th·ªã B√¨nh", class: "6A1", birthDate: "2011-05-20", gender: "N·ªØ", type: "Kh√¥ng b√°n tr√∫" },
                            { id: 3, name: "L√™ Minh C∆∞·ªùng", class: "6A2", birthDate: "2011-07-10", gender: "Nam", type: "B√°n tr√∫" }
                        ];
                        window.attendanceRecords = {};
                        saveData(); 
                    }
                    window.students.sort((a, b) => a.class.localeCompare(b.class, 'vi') || a.name.localeCompare(b.name, 'vi'));
                    updateAllUI();
                }, (error) => {
                    console.error("Error listening to data:", error);
                    alert("M·∫•t k·∫øt n·ªëi v·ªõi d·ªØ li·ªáu th·ªùi gian th·ª±c.");
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                alert("Kh√¥ng th·ªÉ kh·ªüi t·∫°o ·ª©ng d·ª•ng ho·∫∑c k·∫øt n·ªëi d·ªØ li·ªáu.");
            }
        }
        
        initializeFirebase();


        // --- UI UPDATE FUNCTION ---
        function updateAllUI() {
            window.displayStudents();
            window.populateClassFilter();
            window.loadAttendanceForDate();
            window.loadDailyStats();
            window.loadMonthlyStats();
        }

        // --- DATA PERSISTENCE (now using Firestore) ---
        let saveTimeout = null;

        async function saveData(showNotification = false) {
            if (!dataDocRef) {
                console.error("Firestore document reference not initialized.");
                return;
            }
            
            const dataToSave = {
                students: window.students,
                attendanceRecords: window.attendanceRecords,
            };
            
            try {
                await setDoc(dataDocRef, dataToSave);
                if (showNotification) {
                    window.showSaveNotification('‚úÖ D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l∆∞u l√™n ƒë√°m m√¢y!', 'success');
                }
            } catch (error) {
                console.error("Error saving data to Firestore:", error);
                if (showNotification) {
                    window.showSaveNotification('‚ùå L·ªói khi l∆∞u d·ªØ li·ªáu!', 'error');
                }
            }
        }

        // Debounced auto-save function
        window.autoSave = function() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                saveData(false);
                window.showSaveNotification('‚òÅÔ∏è ƒêang ƒë·ªìng b·ªô...', 'info', 1500);
            }, 2000);
        }
    </script>
    
    <script>
        // --- GLOBAL STATE for UI ---
        let dailyStatsFilterStatus = 'all'; // 'all', 'present', 'late', etc.

        // --- INITIALIZATION ---
        window.onload = function() {
            // Set current date for date pickers
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendanceDate').value = today;
            document.getElementById('dailyStatsDate').value = today;
            document.getElementById('monthlyStatsDate').value = today.substring(0, 7);
            
            setTimeout(() => {
                window.showSaveNotification('üéâ Ch√†o m·ª´ng ƒë·∫øn v·ªõi ·ª©ng d·ª•ng ƒëi·ªÉm danh c·ªông t√°c!', 'info', 4000);
            }, 1000);
        };

        // --- TAB MANAGEMENT ---
        window.showTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }
        
        // --- ADMIN PASSWORD CHECK ---
        function checkAdminPassword() {
            // ===============================================================
            // ==> THAY ƒê·ªîI M·∫¨T KH·∫®U C·ª¶A B·∫†N T·∫†I ƒê√ÇY <==
            // Thay ƒë·ªïi chu·ªói "admin" b√™n d∆∞·ªõi th√†nh m·∫≠t kh·∫©u b·∫°n mu·ªën.
            // ===============================================================
            const adminPassword = "admin"; 
            
            const enteredPassword = prompt("Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u qu·∫£n tr·ªã ƒë·ªÉ th·ª±c hi·ªán h√†nh ƒë·ªông n√†y:", "");
            if (enteredPassword === adminPassword) {
                return true;
            } else if (enteredPassword !== null) { // User didn't click cancel
                alert("M·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c!");
            }
            return false;
        }

        // --- UI NOTIFICATIONS ---
        window.showSaveNotification = function(message, type = 'info', duration = 3000) {
            let notification = document.getElementById('saveNotification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'saveNotification';
                notification.style.cssText = `
                    position: fixed; top: 20px; right: 20px; padding: 12px 20px;
                    border-radius: 8px; color: white; font-weight: bold; z-index: 10000;
                    transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    max-width: 300px; word-wrap: break-word; transform: translateY(-20px); opacity: 0;`;
                document.body.appendChild(notification);
            }
            
            const colors = {
                success: 'linear-gradient(135deg, #28a745, #20c997)',
                error: 'linear-gradient(135deg, #dc3545, #e74c3c)',
                info: 'linear-gradient(135deg, #17a2b8, #6c757d)'
            };
            notification.style.background = colors[type] || 'linear-gradient(135deg, #4facfe, #00f2fe)';
            
            notification.textContent = message;
            
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateY(0)';
            }, 10);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-20px)';
            }, duration);
        }

        // --- EXCEL IMPORT/EXPORT ---
        window.handleExcelUpload = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (jsonData.length < 2) {
                        alert('File Excel kh√¥ng c√≥ d·ªØ li·ªáu!');
                        return;
                    }
                    
                    const headers = jsonData[0].map(h => String(h || '').trim().toLowerCase());
                    const columnMap = findColumnIndexes(headers);
                    
                    if (!validateColumns(columnMap)) {
                        alert('File Excel thi·∫øu c√°c c·ªôt b·∫Øt bu·ªôc: H·ªç v√† t√™n, L·ªõp, Ng√†y sinh, Gi·ªõi t√≠nh, Lo·∫°i h·ªçc sinh');
                        return;
                    }
                    
                    window.excelData = jsonData.slice(1).map(row => extractStudentData(row, columnMap)).filter(Boolean);
                    
                    if (window.excelData.length > 0) {
                        document.getElementById('importStatus').textContent = 
                            `‚úÖ ƒê√£ t·∫£i ${window.excelData.length} h·ªçc sinh. Nh·∫•n "Nh·∫≠p t·ª´ Excel" ƒë·ªÉ th√™m.`;
                    } else {
                        alert('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu h·ª£p l·ªá trong file Excel!');
                    }
                } catch (error) {
                    console.error('L·ªói ƒë·ªçc file Excel:', error);
                    alert('C√≥ l·ªói khi ƒë·ªçc file Excel. Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng file!');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function findColumnIndexes(headers) {
            const variants = {
                name: ['h·ªç v√† t√™n', 'h·ªç t√™n'],
                class: ['l·ªõp'],
                birthDate: ['ng√†y sinh'],
                gender: ['gi·ªõi t√≠nh'],
                type: ['lo·∫°i h·ªçc sinh', 'lo·∫°i']
            };
            const columnMap = {};
            for (const key in variants) {
                columnMap[key] = headers.findIndex(h => variants[key].some(v => h.includes(v)));
            }
            return columnMap;
        }

        function validateColumns(columnMap) {
            return Object.values(columnMap).every(index => index !== -1);
        }

        function extractStudentData(row, columnMap) {
            const name = String(row[columnMap.name] || '').trim();
            if (!name) return null;
            return {
                name,
                class: String(row[columnMap.class] || '').trim(),
                birthDate: parseBirthDate(row[columnMap.birthDate]),
                gender: normalizeGender(row[columnMap.gender]),
                type: normalizeStudentType(row[columnMap.type])
            };
        }

        function parseBirthDate(dateValue) {
            if (!dateValue) return '';
            if (typeof dateValue === 'number') {
                const date = new Date(Math.round((dateValue - 25569) * 86400 * 1000));
                return date.toISOString().split('T')[0];
            }
            const date = new Date(dateValue);
            return !isNaN(date.getTime()) ? date.toISOString().split('T')[0] : '';
        }

        function normalizeGender(value) {
            const str = String(value || '').toLowerCase();
            if (str.startsWith('nam')) return 'Nam';
            if (str.startsWith('n·ªØ') || str.startsWith('nu')) return 'N·ªØ';
            return '';
        }

        function normalizeStudentType(value) {
            const str = String(value || '').toLowerCase();
            if (str.includes('b√°n tr√∫')) return 'B√°n tr√∫';
            if (str.includes('kh√¥ng')) return 'Kh√¥ng b√°n tr√∫';
            return '';
        }

        window.importStudentsFromExcel = function() {
            if (!checkAdminPassword()) return;
            if (window.excelData.length === 0) {
                alert('Vui l√≤ng t·∫£i file Excel tr∆∞·ªõc!');
                return;
            }
            
            let addedCount = 0, duplicateCount = 0, updatedCount = 0;
            window.excelData.forEach(studentData => {
                if (!studentData.name || !studentData.class || !studentData.birthDate) return;

                const existingStudentIndex = window.students.findIndex(s => 
                    s.name.toLowerCase() === studentData.name.toLowerCase() && 
                    s.class.toLowerCase() === studentData.class.toLowerCase() &&
                    s.birthDate === studentData.birthDate
                );
                
                if (existingStudentIndex !== -1) {
                    const existingStudent = window.students[existingStudentIndex];
                    if (studentData.type === 'B√°n tr√∫' && existingStudent.type !== 'B√°n tr√∫') {
                        window.students[existingStudentIndex].type = 'B√°n tr√∫';
                        updatedCount++;
                    } else {
                        duplicateCount++;
                    }
                } else {
                    window.students.push({ id: Date.now() + Math.random(), ...studentData });
                    addedCount++;
                }
            });
            
            window.students.sort((a, b) => a.class.localeCompare(b.class, 'vi') || a.name.localeCompare(b.name, 'vi'));
            window.autoSave();
            
            document.getElementById('excelFile').value = '';
            window.excelData = [];
            document.getElementById('importStatus').textContent = '';
            
            alert(`‚úÖ Nh·∫≠p th√†nh c√¥ng ${addedCount} h·ªçc sinh.\nüîÑ C·∫≠p nh·∫≠t ${updatedCount} h·ªçc sinh th√†nh "B√°n tr√∫".\n‚ö†Ô∏è B·ªè qua ${duplicateCount} h·ªçc sinh tr√πng l·∫∑p.`);
        }

        window.downloadExcelTemplate = function() {
            const templateData = [['H·ªç v√† t√™n', 'L·ªõp', 'Ng√†y sinh', 'Gi·ªõi t√≠nh', 'Lo·∫°i h·ªçc sinh']];
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            ws['!cols'] = [{ wch: 25 }, { wch: 10 }, { wch: 15 }, { wch: 12 }, { wch: 18 }];
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Danh s√°ch");
            XLSX.writeFile(wb, "Mau_danh_sach_hoc_sinh.xlsx");
        }

        // --- STUDENT MANAGEMENT ---
        window.addStudent = function() {
            if (!checkAdminPassword()) return;
            const name = document.getElementById('studentName').value.trim();
            const studentClass = document.getElementById('studentClass').value.trim();
            const birthDate = document.getElementById('studentBirthDate').value;
            const gender = document.getElementById('studentGender').value;
            const type = document.getElementById('studentType').value;

            if (!name || !studentClass || !birthDate || !gender || !type) {
                alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                return;
            }

            const existingStudentIndex = window.students.findIndex(s => 
                s.name.toLowerCase() === name.toLowerCase() && 
                s.class.toLowerCase() === studentClass.toLowerCase() &&
                s.birthDate === birthDate
            );

            if (existingStudentIndex !== -1) {
                const existingStudent = window.students[existingStudentIndex];
                if (type === 'B√°n tr√∫' && existingStudent.type !== 'B√°n tr√∫') {
                    if (confirm(`H·ªçc sinh n√†y ƒë√£ t·ªìn t·∫°i v·ªõi lo·∫°i "Kh√¥ng b√°n tr√∫". B·∫°n c√≥ mu·ªën c·∫≠p nh·∫≠t th√†nh "B√°n tr√∫" kh√¥ng?`)) {
                        window.students[existingStudentIndex].type = 'B√°n tr√∫';
                        clearStudentForm();
                        window.autoSave();
                        alert('C·∫≠p nh·∫≠t th√†nh c√¥ng!');
                    }
                } else {
                    alert('H·ªçc sinh n√†y ƒë√£ t·ªìn t·∫°i trong danh s√°ch!');
                }
                return;
            }


            window.students.push({ id: Date.now(), name, class: studentClass, birthDate, gender, type });
            window.students.sort((a, b) => a.class.localeCompare(b.class, 'vi') || a.name.localeCompare(b.name, 'vi'));
            clearStudentForm();
            window.autoSave();
        }

        function clearStudentForm() {
            document.getElementById('studentName').value = '';
            document.getElementById('studentClass').value = '';
            document.getElementById('studentBirthDate').value = '';
            document.getElementById('studentGender').value = '';
            document.getElementById('studentType').value = '';
        }

        window.displayStudents = function() {
            const container = document.getElementById('studentsList');
             document.getElementById('selectAllCheckbox').checked = false; // Uncheck select all
            if (window.students.length === 0) {
                container.innerHTML = `<div class="empty-state"><h3>Ch∆∞a c√≥ h·ªçc sinh n√†o</h3><p>Vui l√≤ng th√™m h·ªçc sinh ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p></div>`;
                return;
            }

            container.innerHTML = window.students.map(student => `
                <div class="student-item">
                    <input type="checkbox" class="student-checkbox" data-id="${student.id}" style="transform: scale(1.5);">
                    <div class="student-item-content">
                        <div class="student-info">
                            <div class="student-detail"><strong>H·ªç v√† t√™n:</strong><span>${student.name}</span></div>
                            <div class="student-detail"><strong>L·ªõp:</strong><span>${student.class}</span></div>
                            <div class="student-detail"><strong>Ng√†y sinh:</strong><span>${formatDate(student.birthDate)}</span></div>
                            <div class="student-detail"><strong>Lo·∫°i:</strong><span>${student.type}</span></div>
                        </div>
                        <div class="attendance-controls">
                            <button class="btn" onclick="editStudent(${student.id})">‚úèÔ∏è S·ª≠a</button>
                            <button class="btn btn-danger" onclick="deleteStudent(${student.id})">üóëÔ∏è X√≥a</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        window.toggleSelectAll = function(checked) {
            const studentCheckboxes = document.querySelectorAll('.student-checkbox');
            studentCheckboxes.forEach(checkbox => {
                checkbox.checked = checked;
            });
        }

        
        window.deleteSelectedStudents = function() {
            if (!checkAdminPassword()) return;
            
            const selectedCheckboxes = document.querySelectorAll('.student-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt h·ªçc sinh ƒë·ªÉ x√≥a.');
                return;
            }

            if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ${selectedCheckboxes.length} h·ªçc sinh ƒë√£ ch·ªçn?`)) {
                const idsToDelete = Array.from(selectedCheckboxes).map(cb => parseFloat(cb.dataset.id));
                window.students = window.students.filter(s => !idsToDelete.includes(s.id));
                window.autoSave();
            }
        }


        window.deleteStudent = function(id) {
            if (!checkAdminPassword()) return;
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a h·ªçc sinh n√†y?')) {
                window.students = window.students.filter(s => s.id !== id);
                window.autoSave();
            }
        }

        window.editStudent = function(id) {
            if (!checkAdminPassword()) return;
            const student = window.students.find(s => s.id === id);
            if (!student) return;

            document.getElementById('studentName').value = student.name;
            document.getElementById('studentClass').value = student.class;
            document.getElementById('studentBirthDate').value = student.birthDate;
            document.getElementById('studentGender').value = student.gender;
            document.getElementById('studentType').value = student.type;

            window.students = window.students.filter(s => s.id !== id);
            window.autoSave();
            
            alert('Th√¥ng tin h·ªçc sinh ƒë√£ ƒë∆∞·ª£c t·∫£i l√™n form. Ch·ªânh s·ª≠a v√† nh·∫•n "Th√™m h·ªçc sinh" ƒë·ªÉ l∆∞u l·∫°i.');
            document.querySelector('#students .form-section').scrollIntoView({ behavior: 'smooth' });
        }

        // --- ATTENDANCE TRACKING ---
        window.populateClassFilter = function() {
            const attendanceFilter = document.getElementById('classFilter');
            const statsFilter = document.getElementById('dailyStatsClassFilter');
            const uniqueClasses = [...new Set(window.students.map(s => s.class))].sort((a,b) => a.localeCompare(b, 'vi'));
            
            const currentAttendanceSelection = attendanceFilter.value;
            const currentStatsSelection = statsFilter.value;

            const optionsHtml = '<option value="all">T·∫•t c·∫£ c√°c l·ªõp</option>' + uniqueClasses.map(className => `<option value="${className}">${className}</option>`).join('');

            attendanceFilter.innerHTML = optionsHtml;
            statsFilter.innerHTML = optionsHtml;
            
            if ([...attendanceFilter.options].some(o => o.value === currentAttendanceSelection)) {
                attendanceFilter.value = currentAttendanceSelection;
            }
             if ([...statsFilter.options].some(o => o.value === currentStatsSelection)) {
                statsFilter.value = currentStatsSelection;
            }
        }

        window.loadAttendanceForDate = function() {
            const selectedDate = document.getElementById('attendanceDate').value;
            const selectedClass = document.getElementById('classFilter').value;
            const container = document.getElementById('attendanceList');
            const title = document.getElementById('attendanceListTitle');

            let filteredStudents = window.students;
            if (selectedClass && selectedClass !== 'all') {
                filteredStudents = window.students.filter(student => student.class === selectedClass);
                title.textContent = `üë®‚Äçüéì ƒêi·ªÉm danh l·ªõp ${selectedClass}`;
            } else {
                title.textContent = `üë®‚Äçüéì ƒêi·ªÉm danh (T·∫•t c·∫£)`;
            }
            
            if (filteredStudents.length === 0) {
                container.innerHTML = `<div class="empty-state"><h3>Kh√¥ng c√≥ h·ªçc sinh n√†o trong l·ªõp n√†y</h3></div>`;
                return;
            }

            const dayRecords = window.attendanceRecords[selectedDate] || {};
            container.innerHTML = filteredStudents.map(student => {
                const record = dayRecords[student.id] || {};
                const status = record.status || 'present';
                return `
                    <div class="student-item">
                         <div class="student-item-content">
                            <div class="student-info">
                                <div class="student-detail"><strong>H·ªç v√† t√™n:</strong><span>${student.name}</span></div>
                                <div class="student-detail"><strong>L·ªõp:</strong><span>${student.class}</span></div>
                                <div class="student-detail"><strong>Ng√†y sinh:</strong><span>${formatDate(student.birthDate)}</span></div>
                                <div class="student-detail"><strong>Tr·∫°ng th√°i:</strong>
                                    <span class="attendance-status ${getStatusClass(status)}">${getStatusText(status)}</span>
                                </div>
                            </div>
                            <div class="attendance-controls">
                                <button class="btn" style="background-color:#28a745; color:white" onclick="markAttendance(${student.id}, 'present')">‚úÖ C√≥ m·∫∑t</button>
                                <button class="btn" style="background: #ffc107; color: black;" onclick="markAttendance(${student.id}, 'late')">‚è∞ Mu·ªôn</button>
                                <button class="btn" style="background: #6c757d; color: white;" onclick="markAttendance(${student.id}, 'absent_excused')">üìã V·∫Øng CP</button>
                                <button class="btn" style="background: #dc3545; color: white;" onclick="markAttendance(${student.id}, 'absent_unexcused')">‚ùå V·∫Øng KP</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.markAttendance = function(studentId, status) {
            const selectedDate = document.getElementById('attendanceDate').value;
            if (!window.attendanceRecords[selectedDate]) {
                window.attendanceRecords[selectedDate] = {};
            }
            window.attendanceRecords[selectedDate][studentId] = {
                status: status,
                timestamp: new Date().toISOString()
            };
            window.autoSave();
        }

        window.markAllPresent = function() {
            const selectedDate = document.getElementById('attendanceDate').value;
            const selectedClass = document.getElementById('classFilter').value;

            let studentsToMark = window.students;
             if (selectedClass && selectedClass !== 'all') {
                studentsToMark = window.students.filter(student => student.class === selectedClass);
            }

            if (studentsToMark.length === 0) {
                alert("Kh√¥ng c√≥ h·ªçc sinh n√†o ƒë·ªÉ ƒëi·ªÉm danh trong l·ªõp ƒë√£ ch·ªçn.");
                return;
            }
            
            if (!window.attendanceRecords[selectedDate]) {
                window.attendanceRecords[selectedDate] = {};
            }
            const timestamp = new Date().toISOString();
            studentsToMark.forEach(student => {
                window.attendanceRecords[selectedDate][student.id] = {
                    status: 'present',
                    timestamp: timestamp
                };
            });
            
            window.autoSave();
            alert(`ƒê√£ ƒëi·ªÉm danh t·∫•t c·∫£ ${studentsToMark.length} h·ªçc sinh c√≥ m·∫∑t!`);
        }

        // --- STATISTICS ---
        window.filterDailyStatsByStatus = function(status) {
            if (dailyStatsFilterStatus === status) {
                dailyStatsFilterStatus = 'all'; // Toggle off if clicked again
            } else {
                dailyStatsFilterStatus = status;
            }
            window.loadDailyStats(); // Refresh the view with the new filter
        }

        window.loadDailyStats = function() {
            const selectedDate = document.getElementById('dailyStatsDate').value;
            const selectedClass = document.getElementById('dailyStatsClassFilter').value;

            let filteredStudents = window.students;
            if (selectedClass && selectedClass !== 'all') {
                filteredStudents = window.students.filter(student => student.class === selectedClass);
            }

            const stats = calculateDayStats(window.attendanceRecords[selectedDate] || {}, filteredStudents);
            const activeFilterClass = (status) => dailyStatsFilterStatus === status ? 'active-filter' : '';

            document.getElementById('dailyStatsGrid').innerHTML = `
                <div class="stats-card ${activeFilterClass('all')}" onclick="filterDailyStatsByStatus('all')"><h4>T·ªïng s·ªë</h4><div class="number">${stats.total}</div></div>
                <div class="stats-card ${activeFilterClass('present')}" onclick="filterDailyStatsByStatus('present')"><h4>C√≥ m·∫∑t</h4><div class="number" style="color: #28a745;">${stats.present}</div></div>
                <div class="stats-card ${activeFilterClass('late')}" onclick="filterDailyStatsByStatus('late')"><h4>ƒêi mu·ªôn</h4><div class="number" style="color: #ffc107;">${stats.late}</div></div>
                <div class="stats-card ${activeFilterClass('absent_total')}" onclick="filterDailyStatsByStatus('absent_total')"><h4>T·ªïng v·∫Øng</h4><div class="number">${stats.absent_total}</div></div>
                <div class="stats-card ${activeFilterClass('absent_unexcused')}" onclick="filterDailyStatsByStatus('absent_unexcused')"><h4>V·∫Øng KP</h4><div class="number" style="color: #dc3545;">${stats.absent_unexcused}</div></div>
                <div class="stats-card ${activeFilterClass('absent_excused')}" onclick="filterDailyStatsByStatus('absent_excused')"><h4>V·∫Øng CP</h4><div class="number" style="color: #6c757d;">${stats.absent_excused}</div></div>
                <div class="stats-card ${activeFilterClass('boarding_absent_unexcused')}" onclick="filterDailyStatsByStatus('boarding_absent_unexcused')"><h4>B√°n tr√∫ v·∫Øng KP</h4><div class="number" style="color: #dc3545;">${stats.boarding_absent_unexcused}</div></div>
                <div class="stats-card ${activeFilterClass('boarding_absent_excused')}" onclick="filterDailyStatsByStatus('boarding_absent_excused')"><h4>B√°n tr√∫ v·∫Øng CP</h4><div class="number" style="color: #6c757d;">${stats.boarding_absent_excused}</div></div>
            `;

            const dayRecords = window.attendanceRecords[selectedDate] || {};
            
            let finalFilteredList = filteredStudents;
            // Filter the list for display based on the selected status
            if (dailyStatsFilterStatus && dailyStatsFilterStatus !== 'all') {
                finalFilteredList = filteredStudents.filter(student => {
                    const record = dayRecords[student.id] || {};
                    const status = record.status || 'present';

                    switch (dailyStatsFilterStatus) {
                        case 'present':
                        case 'late':
                        case 'absent_unexcused':
                        case 'absent_excused':
                            return status === dailyStatsFilterStatus;
                        case 'absent_total':
                            return status === 'absent_unexcused' || status === 'absent_excused';
                        case 'boarding_absent_unexcused':
                            return student.type === 'B√°n tr√∫' && status === 'absent_unexcused';
                        case 'boarding_absent_excused':
                            return student.type === 'B√°n tr√∫' && status === 'absent_excused';
                        default:
                            return true;
                    }
                });
            }

            const detailsHtml = finalFilteredList.map(student => {
                const record = dayRecords[student.id] || {};
                const status = record.status || 'present';
                return `
                    <div class="student-item">
                         <div class="student-item-content">
                            <div class="student-info">
                                <div class="student-detail"><strong>H·ªç v√† t√™n:</strong><span>${student.name}</span></div>
                                 <div class="student-detail"><strong>L·ªõp:</strong><span>${student.class}</span></div>
                                <div class="student-detail"><strong>Tr·∫°ng th√°i:</strong>
                                    <span class="attendance-status ${getStatusClass(status)}">${getStatusText(status)}</span>
                                </div>
                            </div>
                        </div>
                    </div>`;
            }).join('') || `<div class="empty-state"><p>Kh√¥ng c√≥ h·ªçc sinh n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc.</p></div>`;
            
            let title = `<h3>Chi ti·∫øt ng√†y ${formatDate(selectedDate)}</h3>`;
            if (selectedClass && selectedClass !== 'all') {
                title = `<h3>Chi ti·∫øt l·ªõp ${selectedClass} - Ng√†y ${formatDate(selectedDate)}</h3>`;
            }
            document.getElementById('dailyStatsList').innerHTML = title + detailsHtml;
        }

        window.loadMonthlyStats = function() {
            const selectedMonth = document.getElementById('monthlyStatsDate').value;
            if (!selectedMonth) return;
            const [year, month] = selectedMonth.split('-');
            const stats = calculateMonthlyStats(year, month);

            document.getElementById('monthlyStatsGrid').innerHTML = `
                <div class="stats-card"><h4>T·ªïng l∆∞·ª£t c√≥ m·∫∑t</h4><div class="number" style="color: #28a745;">${stats.totalPresent}</div></div>
                <div class="stats-card"><h4>T·ªïng l∆∞·ª£t mu·ªôn</h4><div class="number" style="color: #ffc107;">${stats.totalLate}</div></div>
                <div class="stats-card"><h4>T·ªïng v·∫Øng KP</h4><div class="number" style="color: #dc3545;">${stats.totalAbsentUnexcused}</div></div>
                <div class="stats-card"><h4>T·ªïng v·∫Øng CP</h4><div class="number" style="color: #6c757d;">${stats.totalAbsentExcused}</div></div>
                <div class="stats-card"><h4>B√°n tr√∫ v·∫Øng KP</h4><div class="number" style="color: #dc3545;">${stats.totalBoardingAbsentUnexcused}</div></div>
                <div class="stats-card"><h4>B√°n tr√∫ v·∫Øng CP</h4><div class="number" style="color: #6c757d;">${stats.totalBoardingAbsentExcused}</div></div>
            `;

            const detailsHtml = Object.values(stats.studentData).map(data => {
                const student = data.student;
                return `
                    <div class="student-item">
                        <div class="student-item-content">
                            <div class="student-info">
                                <div class="student-detail"><strong>H·ªç v√† t√™n:</strong><span>${student.name}</span></div>
                                <div class="student-detail"><strong>C√≥ m·∫∑t:</strong><span style="color: #28a745;">${data.present}</span></div>
                                <div class="student-detail"><strong>Mu·ªôn:</strong><span style="color: #ffc107;">${data.late}</span></div>
                                <div class="student-detail"><strong>V·∫Øng KP:</strong><span style="color: #dc3545;">${data.absent_unexcused}</span></div>
                                <div class="student-detail"><strong>V·∫Øng CP:</strong><span style="color: #6c757d;">${data.absent_excused}</span></div>
                            </div>
                        </div>
                    </div>`;
            }).join('');
            document.getElementById('monthlyStatsList').innerHTML = `<h3>Chi ti·∫øt th√°ng ${month}/${year} (ch·ªâ t√≠nh T2-T6)</h3>${detailsHtml}`;
        }

        // --- UTILITY & HELPER FUNCTIONS ---
        function getStatusClass(status) {
            return { 
                present: 'status-present', 
                late: 'status-late', 
                absent_unexcused: 'status-absent-unexcused',
                absent_excused: 'status-absent-excused'
            }[status] || 'status-present';
        }

        function getStatusText(status) {
            return { 
                present: '‚úÖ C√≥ m·∫∑t', 
                late: '‚è∞ Mu·ªôn', 
                absent_unexcused: '‚ùå V·∫Øng KP',
                absent_excused: 'üìã V·∫Øng CP'
            }[status] || '‚úÖ C√≥ m·∫∑t';
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                const userTimezoneOffset = date.getTimezoneOffset() * 60000;
                const correctedDate = new Date(date.getTime() + userTimezoneOffset);
                return correctedDate.toLocaleDateString('vi-VN');
            } catch (e) {
                return dateString;
            }
        }
        
        function formatTimestamp(isoString) {
            if (!isoString) return '';
            try {
                const date = new Date(isoString);
                return date.toLocaleString('vi-VN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            } catch (e) {
                return '';
            }
        }

        function calculateDayStats(dayRecords, studentList) {
            const stats = { 
                total: studentList.length, 
                present: 0, 
                late: 0, 
                absent_unexcused: 0, 
                absent_excused: 0,
                absent_total: 0,
                boarding_absent_unexcused: 0,
                boarding_absent_excused: 0
            };
            studentList.forEach(student => {
                const record = dayRecords[student.id] || {};
                const status = record.status || 'present';
                if(stats.hasOwnProperty(status)) {
                    stats[status]++;
                }
                if (student.type === 'B√°n tr√∫') {
                    if (status === 'absent_unexcused') {
                        stats.boarding_absent_unexcused++;
                    } else if (status === 'absent_excused') {
                        stats.boarding_absent_excused++;
                    }
                }
            });
            stats.absent_total = stats.absent_unexcused + stats.absent_excused;
            return stats;
        }

        function calculateMonthlyStats(year, month) {
            const studentData = {};
            window.students.forEach(s => {
                studentData[s.id] = { 
                    student: s, present: 0, late: 0, absent_unexcused: 0, absent_excused: 0
                };
            });
            
            const daysInMonth = new Date(year, month, 0).getDate();
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month - 1, day);
                const dayOfWeek = currentDate.getDay();

                if (dayOfWeek !== 0 && dayOfWeek !== 6) { // Only count weekdays
                    const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayRecords = window.attendanceRecords[dateStr] || {};
                    window.students.forEach(student => {
                        if (studentData[student.id]) {
                            const record = dayRecords[student.id] || {};
                            const status = record.status || 'present';
                            if(studentData[student.id].hasOwnProperty(status)){
                                studentData[student.id][status]++;
                            }
                        }
                    });
                }
            }
            
            let totalPresent = 0, totalLate = 0, totalAbsentUnexcused = 0, totalAbsentExcused = 0;
            let totalBoardingAbsentUnexcused = 0, totalBoardingAbsentExcused = 0;

            Object.values(studentData).forEach(data => {
                totalPresent += data.present;
                totalLate += data.late;
                totalAbsentUnexcused += data.absent_unexcused;
                totalAbsentExcused += data.absent_excused;

                if (data.student.type === 'B√°n tr√∫') {
                    totalBoardingAbsentUnexcused += data.absent_unexcused;
                    totalBoardingAbsentExcused += data.absent_excused;
                }
            });

            return { studentData, totalPresent, totalLate, totalAbsentUnexcused, totalAbsentExcused, totalBoardingAbsentUnexcused, totalBoardingAbsentExcused };
        }

        // --- EXPORT TO EXCEL FUNCTIONS ---
        window.exportAttendanceToExcel = function() {
            const selectedDate = document.getElementById('attendanceDate').value;
            const dayRecords = window.attendanceRecords[selectedDate] || {};
            const data = window.students.map((s, i) => {
                const record = dayRecords[s.id] || {};
                return {
                    'STT': i + 1,
                    'H·ªç v√† t√™n': s.name,
                    'L·ªõp': s.class,
                    'Ng√†y sinh': formatDate(s.birthDate),
                    'Gi·ªõi t√≠nh': s.gender,
                    'Lo·∫°i h·ªçc sinh': s.type,
                    'Tr·∫°ng th√°i': getStatusText(record.status || 'present'),
                    'Th·ªùi gian c·∫≠p nh·∫≠t': formatTimestamp(record.timestamp)
                };
            });
            const ws = XLSX.utils.json_to_sheet(data);
            ws['!cols'] = [{ wch: 5 }, { wch: 25 }, { wch: 10 }, { wch: 12 }, { wch: 10 }, { wch: 15 }, { wch: 15 }, { wch: 20 }];
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "DiemDanh");
            XLSX.writeFile(wb, `Diem_danh_${selectedDate}.xlsx`);
        }
        
        window.exportDailyStatsToExcel = function() {
            const selectedDate = document.getElementById('dailyStatsDate').value;
            const selectedClass = document.getElementById('dailyStatsClassFilter').value;
            if (!selectedDate) {
                alert('Vui l√≤ng ch·ªçn ng√†y ƒë·ªÉ xu·∫•t th·ªëng k√™!');
                return;
            }

            let filteredStudents = window.students;
            if (selectedClass && selectedClass !== 'all') {
                filteredStudents = window.students.filter(student => student.class === selectedClass);
            }
            
            if (filteredStudents.length === 0) {
                alert('Kh√¥ng c√≥ h·ªçc sinh trong l·ªõp ƒë√£ ch·ªçn ƒë·ªÉ xu·∫•t b√°o c√°o.');
                return;
            }

            const stats = calculateDayStats(window.attendanceRecords[selectedDate] || {}, filteredStudents);
            const dayRecords = window.attendanceRecords[selectedDate] || {};

            const wb = XLSX.utils.book_new();

            // Summary Sheet
            const summaryData = [
                ["Th·ªëng k√™ t·ªïng quan ng√†y", formatDate(selectedDate)],
                ["L·ªõp", selectedClass === 'all' ? 'T·∫•t c·∫£' : selectedClass],
                [],
                ["H·∫°ng m·ª•c", "S·ªë l∆∞·ª£ng"],
                ["T·ªïng s·ªë h·ªçc sinh", stats.total],
                ["C√≥ m·∫∑t", stats.present],
                ["ƒêi mu·ªôn", stats.late],
                ["V·∫Øng kh√¥ng ph√©p (KP)", stats.absent_unexcused],
                ["V·∫Øng c√≥ ph√©p (CP)", stats.absent_excused],
                ["T·ªïng s·ªë v·∫Øng", stats.absent_total],
                ["H·ªçc sinh b√°n tr√∫ v·∫Øng KP", stats.boarding_absent_unexcused],
                ["H·ªçc sinh b√°n tr√∫ v·∫Øng CP", stats.boarding_absent_excused]
            ];
            const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
            ws1['!cols'] = [{ wch: 25 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, ws1, "T·ªïng quan");

            // Detail Sheet
            const detailData = filteredStudents.map((student, index) => {
                const record = dayRecords[student.id] || {};
                return {
                    'STT': index + 1,
                    'H·ªç v√† t√™n': student.name,
                    'L·ªõp': student.class,
                    'Ng√†y sinh': formatDate(student.birthDate),
                    'Gi·ªõi t√≠nh': student.gender,
                    'Lo·∫°i h·ªçc sinh': student.type,
                    'Tr·∫°ng th√°i': getStatusText(record.status || 'present'),
                    'Th·ªùi gian c·∫≠p nh·∫≠t': formatTimestamp(record.timestamp)
                };
            });
            const ws2 = XLSX.utils.json_to_sheet(detailData);
             ws2['!cols'] = [{ wch: 5 }, { wch: 25 }, { wch: 10 }, { wch: 12 }, { wch: 10 }, { wch: 15 }, { wch: 15 }, { wch: 20 }];
            XLSX.utils.book_append_sheet(wb, ws2, "Chi ti·∫øt");

            XLSX.writeFile(wb, `Thong_ke_ngay_${selectedDate}_${selectedClass}.xlsx`);
        }

        window.exportMonthlyStatsToExcel = function() {
            const selectedMonth = document.getElementById('monthlyStatsDate').value;
            if (!selectedMonth) {
                alert('Vui l√≤ng ch·ªçn th√°ng ƒë·ªÉ xu·∫•t th·ªëng k√™!');
                return;
            }
            const [year, month] = selectedMonth.split('-');
            const stats = calculateMonthlyStats(year, month);

            const wb = XLSX.utils.book_new();

            // Summary Sheet
            const summaryData = [
                ["Th·ªëng k√™ t·ªïng quan th√°ng", `${month}/${year}`],
                ["(Ch·ªâ t√≠nh c√°c ng√†y t·ª´ Th·ª© 2 - Th·ª© 6)"],
                [],
                ["H·∫°ng m·ª•c", "T·ªïng s·ªë l∆∞·ª£t"],
                ["T·ªïng l∆∞·ª£t c√≥ m·∫∑t", stats.totalPresent],
                ["T·ªïng l∆∞·ª£t ƒëi mu·ªôn", stats.totalLate],
                ["T·ªïng l∆∞·ª£t v·∫Øng kh√¥ng ph√©p (KP)", stats.totalAbsentUnexcused],
                ["T·ªïng l∆∞·ª£t v·∫Øng c√≥ ph√©p (CP)", stats.totalAbsentExcused],
                ["T·ªïng l∆∞·ª£t b√°n tr√∫ v·∫Øng KP", stats.totalBoardingAbsentUnexcused],
                ["T·ªïng l∆∞·ª£t b√°n tr√∫ v·∫Øng CP", stats.totalBoardingAbsentExcused]
            ];
            const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
            ws1['!cols'] = [{ wch: 35 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, ws1, "T·ªïng quan th√°ng");

            // Detail Sheet
            const detailData = Object.values(stats.studentData).map((data, index) => ({
                'STT': index + 1,
                'H·ªç v√† t√™n': data.student.name,
                'L·ªõp': data.student.class,
                'Ng√†y sinh': formatDate(data.student.birthDate),
                'Gi·ªõi t√≠nh': data.student.gender,
                'Lo·∫°i h·ªçc sinh': data.student.type,
                'C√≥ m·∫∑t': data.present,
                'ƒêi mu·ªôn': data.late,
                'V·∫Øng KP': data.absent_unexcused,
                'V·∫Øng CP': data.absent_excused
            }));
            const ws2 = XLSX.utils.json_to_sheet(detailData);
            ws2['!cols'] = [{ wch: 5 }, { wch: 25 }, { wch: 10 }, { wch: 12 }, { wch: 10 }, { wch: 15 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 10 }];
            XLSX.utils.book_append_sheet(wb, ws2, "Chi ti·∫øt th√°ng");

            XLSX.writeFile(wb, `Thong_ke_thang_${month}_${year}.xlsx`);
        }

        // --- MISC UI FUNCTIONS ---
        window.showSaveLog = function() {
            alert("Nh·∫≠t k√Ω l∆∞u:\nD·ªØ li·ªáu c·ªßa b·∫°n ƒë∆∞·ª£c l∆∞u v√† ƒë·ªìng b·ªô t·ª± ƒë·ªông l√™n ƒë√°m m√¢y. M·ªçi ng∆∞·ªùi d√πng chung App ID s·∫Ω th·∫•y c√πng m·ªôt d·ªØ li·ªáu.");
        }
    </script>
</body>
</html>
