<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phần mềm điểm danh học sinh (Sáng/Chiều)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* General styling for the entire page */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px; /* Reduced padding for mobile */
        }

        /* Main container for the application */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* Header section */
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px; /* Adjusted padding */
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2rem; /* Adjusted font size */
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1rem; /* Adjusted font size */
            opacity: 0.9;
        }
        
        #app-id-container {
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-top: 15px;
            display: inline-block;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        #app-id-container span {
            font-weight: bold;
            color: #fff;
        }


        /* Tab navigation */
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            flex-wrap: wrap; /* Allow tabs to wrap on small screens */
        }

        .tab {
            flex: 1 1 auto; /* Allow tabs to grow and shrink */
            padding: 15px 10px; /* Adjusted padding */
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem; /* Adjusted font size */
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
            text-align: center;
        }

        .tab.active {
            background: white;
            color: #4facfe;
            border-bottom: 3px solid #4facfe;
        }

        .tab:hover:not(.active) {
            background: #e9ecef;
            color: #495057;
        }

        /* Content for each tab */
        .tab-content {
            display: none;
            padding: 20px; /* Adjusted padding */
        }

        .tab-content.active {
            display: block;
        }

        /* Styling for form sections */
        .form-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px; /* Adjusted padding */
            margin-bottom: 25px;
            border-left: 4px solid #4facfe;
        }

        .form-section h3 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Adjusted minmax */
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
            width: 100%; /* Ensure full width */
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        /* General button styling */
        .btn {
            padding: 12px 20px; /* Adjusted padding */
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center; /* Center content */
            gap: 8px;
            width: 100%; /* Make buttons full width on mobile */
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }


        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
        }
        
        /* Student list styling */
        .student-list {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .student-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 15px 20px;
        }
        
        .student-list-header h3 {
            margin: 0;
            font-size: 1.3rem;
        }
        
        .student-list-header .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .student-item {
            padding: 15px; /* Adjusted padding */
            border-bottom: 1px solid #e9ecef;
            display: grid;
            grid-template-columns: auto 1fr; /* Checkbox and content */
            gap: 15px; 
            align-items: center;
            transition: all 0.3s ease;
        }

        .student-item:hover {
            background: #f8f9fa;
        }
        
        .student-item-content {
            display: grid;
            grid-template-columns: 1fr; /* Single column layout for mobile */
            gap: 15px; /* Gap between info and controls */
            align-items: center;
        }

        .student-info {
            display: grid;
            grid-template-columns: 1fr; /* Single column for details */
            gap: 10px; /* Adjusted gap */
        }
        
        .student-detail {
            display: flex;
            flex-direction: column;
        }

        .student-detail strong {
            color: #495057;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .student-detail span {
            color: #6c757d;
            font-size: 1rem;
        }
        
        .daily-stats-statuses {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }


        /* Attendance controls and status styling */
        .attendance-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center; /* Center buttons on mobile */
        }
        
        .attendance-controls .btn {
            flex: 1 1 100px; /* Allow buttons to grow and shrink */
        }

        .session-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 10px;
        }
        
        .session-selector .btn {
            flex: 1;
            background-color: #f8f9fa;
            color: #495057;
            border: 2px solid #dee2e6;
        }
        .session-selector .btn.active {
            background: #4facfe;
            color: white;
            border-color: #4facfe;
            box-shadow: 0 4px 10px rgba(79, 172, 254, 0.3);
        }


        .attendance-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            border: 2px solid transparent;
            text-align: center;
        }

        .status-present { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .status-late { background: #fff3cd; color: #856404; border-color: #ffeaa7; }
        .status-absent-unexcused { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .status-absent-excused { background: #e2e3e5; color: #383d41; border-color: #d6d8db; }
        .status-na { background: #f0f0f0; color: #6c757d; border-color: #ccc; }


        /* Quick actions bar */
        .quick-actions {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .quick-actions .btn {
             flex: 1 1 150px; /* Responsive buttons */
        }

        /* Statistics grid and cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); /* Adjusted minmax */
            gap: 15px; /* Adjusted gap */
            margin-bottom: 25px;
        }

        .stats-card {
            background: white;
            border-radius: 10px;
            padding: 15px; /* Adjusted padding */
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #4facfe;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stats-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.15); }
        .stats-card h4 { color: #495057; margin-bottom: 10px; font-size: 0.8rem; } /* Adjusted font size */
        .stats-card .number { font-size: 1.8rem; font-weight: bold; color: #4facfe; } /* Adjusted font size */

        /* Date filter section */
        .date-filter { background: white; border-radius: 10px; padding: 20px; margin-bottom: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .filter-row { display: grid; grid-template-columns: 1fr; gap: 15px; align-items: end; } /* Single column by default */
        
        /* Empty state for lists */
        .empty-state { text-align: center; padding: 60px 20px; color: #6c757d; }
        .empty-state h3 { margin-bottom: 10px; color: #495057; }
        
        /* --- Desktop and Tablet Styles --- */
        @media (min-width: 768px) {
             body {
                padding: 20px; /* Restore padding for larger screens */
            }
            .header h1 {
                font-size: 2.5rem; /* Restore font size */
            }
             .header p {
                font-size: 1.1rem; /* Restore font size */
            }
            .tab {
                font-size: 1rem; /* Restore font size */
                 padding: 15px 20px; /* Restore padding */
            }
            .tab-content, .form-section {
                 padding: 30px; /* Restore padding */
            }
            .btn {
                width: auto; /* Buttons are not full width on desktop */
            }
            .filter-row {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Multi-column layout */
            }
            .student-item-content {
                 grid-template-columns: 1fr auto; /* Two columns for info and controls */
                 gap: 20px;
            }
            .student-info {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Responsive grid for info */
                gap: 15px;
            }
             .attendance-controls {
                justify-content: flex-end; /* Align buttons to the right */
            }
            .attendance-controls .btn {
                 flex-grow: 0; /* Prevent buttons from growing too large */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📚 Phần mềm điểm danh học sinh</h1>
            <p>Cộng tác điểm danh Sáng/Chiều</p>
            <div id="app-id-container">
                Mã chia sẻ (App ID): <span id="appIdDisplay">Đang tải...</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('students')">👥 Quản lý học sinh</button>
            <button class="tab" onclick="showTab('attendance')">📝 Điểm danh</button>
            <button class="tab" onclick="showTab('daily-stats')">📊 Thống kê hàng ngày</button>
            <button class="tab" onclick="showTab('monthly-stats')">📈 Thống kê hàng tháng</button>
        </div>

        <div id="students" class="tab-content active">
            <div class="form-section">
                <h3>📁 Nhập danh sách từ Excel</h3>
                <div class="form-row">
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Chọn file Excel (*.xlsx, *.xls)</label>
                        <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="handleExcelUpload(event)">
                        <small style="color: #6c757d; margin-top: 5px; display: block;">
                            📋 File Excel cần có các cột: <strong>Họ và tên, Lớp, Ngày sinh, Giới tính, Loại học sinh</strong>
                        </small>
                    </div>
                </div>
                <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                    <button class="btn btn-success" onclick="importStudentsFromExcel()">
                        📥 Nhập từ Excel
                    </button>
                    <button class="btn btn-info" onclick="downloadExcelTemplate()">
                        📄 Tải mẫu Excel
                    </button>
                    <span id="importStatus" style="color: #28a745; font-weight: bold;"></span>
                </div>
            </div>

            <div class="form-section">
                <h3>➕ Thêm học sinh mới</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Họ và tên</label>
                        <input type="text" id="studentName" placeholder="Nhập họ và tên học sinh">
                    </div>
                    <div class="form-group">
                        <label>Lớp</label>
                        <input type="text" id="studentClass" placeholder="Ví dụ: 6A1">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ngày sinh</label>
                        <input type="date" id="studentBirthDate">
                    </div>
                    <div class="form-group">
                        <label>Giới tính</label>
                        <select id="studentGender">
                            <option value="">-- Chọn giới tính --</option>
                            <option value="Nam">Nam</option>
                            <option value="Nữ">Nữ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Loại học sinh</label>
                        <select id="studentType">
                            <option value="">-- Chọn loại --</option>
                            <option value="Bán trú">Bán trú</option>
                            <option value="Không bán trú">Không bán trú</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addStudent()">➕ Thêm học sinh</button>
            </div>

            <div class="student-list">
                <div class="student-list-header">
                    <h3>📋 Danh sách học sinh</h3>
                    <div class="header-controls">
                        <label>
                            <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this.checked)" style="transform: scale(1.5);">
                            Chọn tất cả
                        </label>
                        <button class="btn btn-danger" style="width: auto; padding: 8px 15px;" onclick="deleteSelectedStudents()">🗑️ Xóa đã chọn</button>
                    </div>
                </div>
                <div id="studentsList"></div>
            </div>
        </div>

        <div id="attendance" class="tab-content">
            <div class="quick-actions">
                <button class="btn btn-success" onclick="markAllPresent()">✅ Tất cả có mặt (buổi hiện tại)</button>
                <button class="btn btn-info" onclick="exportAttendanceToExcel()">📁 Xuất Excel</button>
            </div>

            <div class="date-filter">
                <h4>📅 Lọc và điểm danh</h4>
                <div class="filter-row">
                    <div class="form-group">
                        <label for="attendanceDate">Chọn ngày điểm danh</label>
                        <input type="date" id="attendanceDate" onchange="loadAttendanceForDate()">
                    </div>
                    <div class="form-group">
                        <label for="classFilter">Chọn lớp</label>
                        <select id="classFilter" onchange="loadAttendanceForDate()"></select>
                    </div>
                </div>
                <div class="session-selector">
                    <button id="session-morning" class="btn active" onclick="selectSession('morning')">☀️ Buổi Sáng</button>
                    <button id="session-afternoon" class="btn" onclick="selectSession('afternoon')">🌙 Buổi Chiều</button>
                </div>
            </div>

            <div class="student-list">
                <h3 id="attendanceListTitle">👨‍🎓 Điểm danh học sinh</h3>
                <div id="attendanceList"></div>
            </div>
        </div>

        <div id="daily-stats" class="tab-content">
            <div class="date-filter">
                <div class="filter-row">
                    <div class="form-group">
                        <label>Chọn ngày thống kê</label>
                        <input type="date" id="dailyStatsDate" onchange="loadDailyStats()">
                    </div>
                    <div class="form-group">
                        <label for="dailyStatsClassFilter">Chọn lớp</label>
                        <select id="dailyStatsClassFilter" onchange="loadDailyStats()"></select>
                    </div>
                    <div class="form-group">
                         <button class="btn btn-info" onclick="loadDailyStats()">📊 Xem thống kê</button>
                    </div>
                     <div class="form-group">
                        <button class="btn btn-success" onclick="exportDailyStatsToExcel()">📁 Xuất Excel</button>
                    </div>
                </div>
            </div>

            <div class="stats-grid" id="dailyStatsGrid"></div>
            <div class="student-list" id="dailyStatsList"></div>
        </div>

        <div id="monthly-stats" class="tab-content">
            <div class="date-filter">
                <div class="filter-row">
                    <div class="form-group">
                        <label>Chọn tháng/năm</label>
                        <input type="month" id="monthlyStatsDate" onchange="loadMonthlyStats()">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-info" onclick="loadMonthlyStats()">📈 Xem thống kê</button>
                    </div>
                     <div class="form-group">
                        <button class="btn btn-success" onclick="exportMonthlyStatsToExcel()">📁 Xuất Excel</button>
                    </div>
                </div>
            </div>

            <div class="stats-grid" id="monthlyStatsGrid"></div>
            <div class="student-list" id="monthlyStatsList"></div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- GLOBAL VARIABLES ---
        const appId = 'diem-danh-NTTo';
        const firebaseConfig = {
    		apiKey: "AIzaSyBbNvKLgj8QdM22rqxnS65cJGSF5wNUIJE",
    		authDomain: "diem-danh-20xx.firebaseapp.com",
    		projectId: "diem-danh-20xx",
    		storageBucket: "diem-danh-20xx.firebasestorage.app",
    		messagingSenderId: "474588160188",
    		appId: "1:474588160188:web:37a1b187369ff47e56f0b9",
    		measurementId: "G-CYHW7NZKGM"
  		};
        
        let db;
        let auth;
        let dataDocRef;

        // --- DATA MANAGEMENT ---
        window.students = [];
        window.attendanceRecords = {};
        window.excelData = [];

        // --- FIREBASE INITIALIZATION ---
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            document.getElementById('appIdDisplay').textContent = appId;
        } catch (e) {
            console.error("Error initializing Firebase:", e);
            alert("Không thể kết nối đến cơ sở dữ liệu. Vui lòng thử lại.");
        }

        // --- ASYNC AUTH & DATA LISTENER SETUP ---
        async function initializeFirebase() {
            try {
                await signInAnonymously(auth);
                const user = auth.currentUser;
                if (!user) {
                    throw new Error("Authentication failed, user is null.");
                }

                dataDocRef = doc(db, "artifacts", appId, "public", "data", "attendance", "mainDoc");

                onSnapshot(dataDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        window.students = data.students || [];
                        window.attendanceRecords = data.attendanceRecords || {};
                    } else {
                        window.students = [];
                        window.attendanceRecords = {};
                    }
                    window.sortStudents();
                    updateAllUI();
                }, (error) => {
                    console.error("Error listening to data:", error);
                    alert("Mất kết nối với dữ liệu thời gian thực.");
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                alert("Không thể khởi tạo ứng dụng hoặc kết nối dữ liệu.");
            }
        }
        
        initializeFirebase();

        // --- UI UPDATE FUNCTION ---
        function updateAllUI() {
            window.displayStudents();
            window.populateClassFilter();
            window.loadAttendanceForDate();
            window.loadDailyStats();
            window.loadMonthlyStats();
        }

        // --- DATA PERSISTENCE ---
        let saveTimeout = null;
        async function saveData() {
            if (!dataDocRef) {
                console.error("Firestore document reference not initialized.");
                return;
            }
            const dataToSave = {
                students: window.students,
                attendanceRecords: window.attendanceRecords,
            };
            try {
                await setDoc(dataDocRef, dataToSave);
            } catch (error) {
                console.error("Error saving data to Firestore:", error);
            }
        }

        window.autoSave = function() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveData, 2000);
        }
    </script>
    
    <script>
        // --- GLOBAL STATE for UI ---
        let currentSession = 'morning'; // 'morning' or 'afternoon'

        // --- INITIALIZATION ---
        window.onload = function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendanceDate').value = today;
            document.getElementById('dailyStatsDate').value = today;
            document.getElementById('monthlyStatsDate').value = today.substring(0, 7);
        };

        // --- TAB & SESSION MANAGEMENT ---
        window.showTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }
        
        window.selectSession = function(session) {
            currentSession = session;
            document.getElementById('session-morning').classList.toggle('active', session === 'morning');
            document.getElementById('session-afternoon').classList.toggle('active', session === 'afternoon');
            loadAttendanceForDate();
        }

        // --- ADMIN PASSWORD ---
        function checkAdminPassword() {
            const adminPassword = "admin"; 
            const enteredPassword = prompt("Vui lòng nhập mật khẩu quản trị:", "");
            if (enteredPassword === adminPassword) return true;
            if (enteredPassword !== null) alert("Mật khẩu không chính xác!");
            return false;
        }

        // --- STUDENT SORTING & MANAGEMENT (UNCHANGED) ---
        function getSortableName(name) {
            const parts = name.trim().split(/\s+/);
            const lastName = parts.pop() || '';
            const firstName = parts.join(' ');
            return { lastName, firstName };
        }
        window.sortStudents = function() {
            window.students.sort((a, b) => {
                const classCompare = a.class.localeCompare(b.class, 'vi');
                if (classCompare !== 0) return classCompare;
                const nameA = getSortableName(a.name);
                const nameB = getSortableName(b.name);
                const lastNameCompare = nameA.lastName.localeCompare(nameB.lastName, 'vi');
                return lastNameCompare !== 0 ? lastNameCompare : nameA.firstName.localeCompare(nameB.firstName, 'vi');
            });
        }
        // ... (All other student management functions like add, delete, edit, import remain here and are unchanged)
        
        window.displayStudents = function() {
            const container = document.getElementById('studentsList');
             document.getElementById('selectAllCheckbox').checked = false; 
            if (window.students.length === 0) {
                container.innerHTML = `<div class="empty-state"><h3>Chưa có học sinh nào</h3><p>Vui lòng thêm học sinh để bắt đầu.</p></div>`;
                return;
            }

            container.innerHTML = window.students.map(student => `
                <div class="student-item">
                    <input type="checkbox" class="student-checkbox" data-id="${student.id}" style="transform: scale(1.5);">
                    <div class="student-item-content">
                        <div class="student-info">
                            <div class="student-detail"><strong>Họ và tên:</strong><span>${student.name}</span></div>
                            <div class="student-detail"><strong>Lớp:</strong><span>${student.class}</span></div>
                            <div class="student-detail"><strong>Ngày sinh:</strong><span>${formatDate(student.birthDate)}</span></div>
                            <div class="student-detail"><strong>Loại:</strong><span>${student.type}</span></div>
                        </div>
                        <div class="attendance-controls">
                            <button class="btn" onclick="editStudent(${student.id})">✏️ Sửa</button>
                            <button class="btn btn-danger" onclick="deleteStudent(${student.id})">🗑️ Xóa</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // ... (Add, delete, edit, excel import/export functions for students are here, unchanged)
        
        // --- ATTENDANCE TRACKING (MODIFIED FOR SESSIONS) ---
        window.populateClassFilter = function() {
            const filters = [document.getElementById('classFilter'), document.getElementById('dailyStatsClassFilter')];
            const uniqueClasses = [...new Set(window.students.map(s => s.class))].sort((a,b) => a.localeCompare(b, 'vi'));
            const optionsHtml = '<option value="all">Tất cả các lớp</option>' + uniqueClasses.map(c => `<option value="${c}">${c}</option>`).join('');
            filters.forEach(filter => {
                const currentVal = filter.value;
                filter.innerHTML = optionsHtml;
                if ([...filter.options].some(o => o.value === currentVal)) filter.value = currentVal;
            });
        }

        window.loadAttendanceForDate = function() {
            const selectedDate = document.getElementById('attendanceDate').value;
            const selectedClass = document.getElementById('classFilter').value;
            const container = document.getElementById('attendanceList');
            const title = document.getElementById('attendanceListTitle');

            let filteredStudents = window.students;
            if (selectedClass && selectedClass !== 'all') {
                filteredStudents = window.students.filter(student => student.class === selectedClass);
            } 
            
            title.textContent = `👨‍🎓 Điểm danh ${selectedClass === 'all' ? 'tất cả các lớp' : 'lớp ' + selectedClass} - Buổi ${currentSession === 'morning' ? 'Sáng' : 'Chiều'}`;
            
            if (filteredStudents.length === 0) {
                container.innerHTML = `<div class="empty-state"><h3>Không có học sinh nào.</h3></div>`;
                return;
            }

            const dayRecords = window.attendanceRecords[selectedDate] || {};
            container.innerHTML = filteredStudents.map(student => {
                const studentRecord = dayRecords[student.id] || {};
                const sessionRecord = studentRecord[currentSession] || {};
                const status = sessionRecord.status || 'present';
                return `
                    <div class="student-item">
                         <div class="student-item-content">
                            <div class="student-info">
                                <div class="student-detail"><strong>Họ và tên:</strong><span>${student.name}</span></div>
                                <div class="student-detail"><strong>Lớp:</strong><span>${student.class}</span></div>
                                <div class="student-detail"><strong>Trạng thái:</strong>
                                    <span class="attendance-status ${getStatusClass(status)}">${getStatusText(status)}</span>
                                </div>
                            </div>
                            <div class="attendance-controls">
                                <button class="btn" style="background-color:#28a745; color:white" onclick="markAttendance(${student.id}, 'present')">✅ Có mặt</button>
                                <button class="btn" style="background: #ffc107; color: black;" onclick="markAttendance(${student.id}, 'late')">⏰ Muộn</button>
                                <button class="btn" style="background: #6c757d; color: white;" onclick="markAttendance(${student.id}, 'absent_excused')">📋 Vắng CP</button>
                                <button class="btn" style="background: #dc3545; color: white;" onclick="markAttendance(${student.id}, 'absent_unexcused')">❌ Vắng KP</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.markAttendance = function(studentId, status) {
            const selectedDate = document.getElementById('attendanceDate').value;
            if (!window.attendanceRecords[selectedDate]) window.attendanceRecords[selectedDate] = {};
            if (!window.attendanceRecords[selectedDate][studentId]) window.attendanceRecords[selectedDate][studentId] = {};
            
            window.attendanceRecords[selectedDate][studentId][currentSession] = {
                status: status,
                timestamp: new Date().toISOString()
            };
            window.autoSave();
        }

        window.markAllPresent = function() {
            if (!checkAdminPassword()) return;
            const selectedDate = document.getElementById('attendanceDate').value;
            const selectedClass = document.getElementById('classFilter').value;

            let studentsToMark = (selectedClass && selectedClass !== 'all') 
                ? window.students.filter(s => s.class === selectedClass) 
                : window.students;

            if (studentsToMark.length === 0) return;
            
            if (!window.attendanceRecords[selectedDate]) window.attendanceRecords[selectedDate] = {};
            
            const timestamp = new Date().toISOString();
            studentsToMark.forEach(student => {
                if (!window.attendanceRecords[selectedDate][student.id]) window.attendanceRecords[selectedDate][student.id] = {};
                window.attendanceRecords[selectedDate][student.id][currentSession] = { status: 'present', timestamp };
            });
            
            window.autoSave();
            alert(`Đã điểm danh tất cả ${studentsToMark.length} học sinh có mặt cho buổi ${currentSession === 'morning' ? 'Sáng' : 'Chiều'}!`);
        }

        // --- STATISTICS (MODIFIED FOR SESSIONS) ---
        window.loadDailyStats = function() {
            const selectedDate = document.getElementById('dailyStatsDate').value;
            const selectedClass = document.getElementById('dailyStatsClassFilter').value;

            let filteredStudents = (selectedClass && selectedClass !== 'all')
                ? window.students.filter(s => s.class === selectedClass)
                : window.students;

            const stats = calculateDayStats(window.attendanceRecords[selectedDate] || {}, filteredStudents);

            document.getElementById('dailyStatsGrid').innerHTML = `
                <div class="stats-card"><h4>Tổng số</h4><div class="number">${stats.total}</div></div>
                <div class="stats-card"><h4>Vắng KP Sáng</h4><div class="number" style="color: #dc3545;">${stats.morning.absent_unexcused}</div></div>
                <div class="stats-card"><h4>Vắng CP Sáng</h4><div class="number" style="color: #6c757d;">${stats.morning.absent_excused}</div></div>
                <div class="stats-card"><h4>Muộn Sáng</h4><div class="number" style="color: #ffc107;">${stats.morning.late}</div></div>
                <div class="stats-card"><h4>Vắng KP Chiều</h4><div class="number" style="color: #dc3545;">${stats.afternoon.absent_unexcused}</div></div>
                <div class="stats-card"><h4>Vắng CP Chiều</h4><div class="number" style="color: #6c757d;">${stats.afternoon.absent_excused}</div></div>
                <div class="stats-card"><h4>Muộn Chiều</h4><div class="number" style="color: #ffc107;">${stats.afternoon.late}</div></div>
                 <div class="stats-card"><h4>Tổng Vắng</h4><div class="number">${stats.combined.absent_total}</div></div>
            `;

            const dayRecords = window.attendanceRecords[selectedDate] || {};
            const detailsHtml = filteredStudents.map(student => {
                const record = dayRecords[student.id] || {};
                const morningStatus = record.morning?.status || 'present';
                const afternoonStatus = record.afternoon?.status || 'present';

                return `
                    <div class="student-item">
                         <div class="student-item-content">
                            <div class="student-info">
                                <div class="student-detail"><strong>Họ và tên:</strong><span>${student.name}</span></div>
                                <div class="student-detail"><strong>Lớp:</strong><span>${student.class}</span></div>
                                <div class="student-detail"><strong>Trạng thái:</strong>
                                    <div class="daily-stats-statuses">
                                        <span class="attendance-status ${getStatusClass(morningStatus)}">S: ${getStatusText(morningStatus, true)}</span>
                                        <span class="attendance-status ${getStatusClass(afternoonStatus)}">C: ${getStatusText(afternoonStatus, true)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
            }).join('') || `<div class="empty-state"><p>Không có học sinh.</p></div>`;
            
            let title = `<h3>Chi tiết ngày ${formatDate(selectedDate)} (${selectedClass === 'all' ? 'Tất cả' : 'Lớp ' + selectedClass})</h3>`;
            document.getElementById('dailyStatsList').innerHTML = title + detailsHtml;
        }

        window.loadMonthlyStats = function() {
            const selectedMonth = document.getElementById('monthlyStatsDate').value;
            if (!selectedMonth) return;
            const [year, month] = selectedMonth.split('-');
            const stats = calculateMonthlyStats(year, month);

            document.getElementById('monthlyStatsGrid').innerHTML = `
                <div class="stats-card"><h4>Tổng buổi có mặt</h4><div class="number" style="color: #28a745;">${stats.totalPresent}</div></div>
                <div class="stats-card"><h4>Tổng buổi muộn</h4><div class="number" style="color: #ffc107;">${stats.totalLate}</div></div>
                <div class="stats-card"><h4>Tổng buổi vắng KP</h4><div class="number" style="color: #dc3545;">${stats.totalAbsentUnexcused}</div></div>
                <div class="stats-card"><h4>Tổng buổi vắng CP</h4><div class="number" style="color: #6c757d;">${stats.totalAbsentExcused}</div></div>
            `;

            const detailsHtml = Object.values(stats.studentData).map(data => {
                return `
                    <div class="student-item">
                        <div class="student-item-content">
                            <div class="student-info">
                                <div class="student-detail"><strong>Họ và tên:</strong><span>${data.student.name}</span></div>
                                <div class="student-detail"><strong>Có mặt:</strong><span style="color: #28a745;">${data.present}</span></div>
                                <div class="student-detail"><strong>Muộn:</strong><span style="color: #ffc107;">${data.late}</span></div>
                                <div class="student-detail"><strong>Vắng KP:</strong><span style="color: #dc3545;">${data.absent_unexcused}</span></div>
                                <div class="student-detail"><strong>Vắng CP:</strong><span style="color: #6c757d;">${data.absent_excused}</span></div>
                            </div>
                        </div>
                    </div>`;
            }).join('');
            document.getElementById('monthlyStatsList').innerHTML = `<h3>Tổng hợp các buổi trong tháng ${month}/${year} (T2-T6)</h3>${detailsHtml}`;
        }

        // --- UTILITY & HELPER FUNCTIONS ---
        function getStatusClass(status) {
            return { present: 'status-present', late: 'status-late', absent_unexcused: 'status-absent-unexcused', absent_excused: 'status-absent-excused' }[status] || 'status-present';
        }

        function getStatusText(status, short = false) {
            const text = { present: 'Có mặt', late: 'Muộn', absent_unexcused: 'Vắng KP', absent_excused: 'Vắng CP' }[status] || 'Có mặt';
            return short ? text : ( {present: '✅ ', late: '⏰ ', absent_unexcused: '❌ ', absent_excused: '📋 '}[status] || '✅ ') + text;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            const userTimezoneOffset = date.getTimezoneOffset() * 60000;
            return new Date(date.getTime() + userTimezoneOffset).toLocaleDateString('vi-VN');
        }
        
        function formatTimestamp(isoString) {
            if (!isoString) return '';
            return new Date(isoString).toLocaleString('vi-VN', { hour: '2-digit', minute: '2-digit' });
        }
        
        function createStatCounter() {
            return { present: 0, late: 0, absent_unexcused: 0, absent_excused: 0, absent_total: 0 };
        }

        function calculateDayStats(dayRecords, studentList) {
            const stats = { 
                total: studentList.length,
                morning: createStatCounter(),
                afternoon: createStatCounter(),
                combined: createStatCounter()
            };

            studentList.forEach(student => {
                const record = dayRecords[student.id] || {};
                const mStatus = record.morning?.status || 'present';
                const aStatus = record.afternoon?.status || 'present';

                stats.morning[mStatus]++;
                stats.afternoon[aStatus]++;
            });

            ['morning', 'afternoon'].forEach(session => {
                stats[session].absent_total = stats[session].absent_unexcused + stats[session].absent_excused;
            });
            
            stats.combined.absent_total = stats.morning.absent_total + stats.afternoon.absent_total;

            return stats;
        }

        function calculateMonthlyStats(year, month) {
            const studentData = {};
            window.students.forEach(s => {
                studentData[s.id] = { student: s, ...createStatCounter() };
            });
            
            const daysInMonth = new Date(year, month, 0).getDate();
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month - 1, day);
                const dayOfWeek = date.getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) continue; // Skip weekends

                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayRecords = window.attendanceRecords[dateStr] || {};
                
                window.students.forEach(student => {
                    const studentStats = studentData[student.id];
                    if (studentStats) {
                        const record = dayRecords[student.id] || {};
                        const mStatus = record.morning?.status || 'present';
                        const aStatus = record.afternoon?.status || 'present';
                        studentStats[mStatus]++;
                        studentStats[aStatus]++;
                    }
                });
            }
            
            let totalPresent = 0, totalLate = 0, totalAbsentUnexcused = 0, totalAbsentExcused = 0;
            Object.values(studentData).forEach(data => {
                totalPresent += data.present;
                totalLate += data.late;
                totalAbsentUnexcused += data.absent_unexcused;
                totalAbsentExcused += data.absent_excused;
            });

            return { studentData, totalPresent, totalLate, totalAbsentUnexcused, totalAbsentExcused };
        }

        // --- EXPORT TO EXCEL FUNCTIONS (MODIFIED FOR SESSIONS) ---
        window.exportAttendanceToExcel = function() {
            if (!checkAdminPassword()) return;
            const selectedDate = document.getElementById('attendanceDate').value;
            const dayRecords = window.attendanceRecords[selectedDate] || {};
            const data = window.students.map((s, i) => {
                const record = dayRecords[s.id] || {};
                return {
                    'STT': i + 1, 'Họ và tên': s.name, 'Lớp': s.class,
                    'Trạng thái Sáng': getStatusText(record.morning?.status || 'present', true),
                    'TG Sáng': formatTimestamp(record.morning?.timestamp),
                    'Trạng thái Chiều': getStatusText(record.afternoon?.status || 'present', true),
                    'TG Chiều': formatTimestamp(record.afternoon?.timestamp),
                };
            });
            const ws = XLSX.utils.json_to_sheet(data);
            ws['!cols'] = [{ wch: 5 }, { wch: 25 }, { wch: 10 }, { wch: 15 }, { wch: 12 }, { wch: 15 }, { wch: 12 }];
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, `DiemDanh_${selectedDate}`);
            XLSX.writeFile(wb, `Diem_danh_${selectedDate}.xlsx`);
        }
        
        window.exportDailyStatsToExcel = function() {
            if (!checkAdminPassword()) return;
            const selectedDate = document.getElementById('dailyStatsDate').value;
            const selectedClass = document.getElementById('dailyStatsClassFilter').value;
            let filteredStudents = (selectedClass !== 'all') ? window.students.filter(s => s.class === selectedClass) : window.students;
            
            const stats = calculateDayStats(window.attendanceRecords[selectedDate] || {}, filteredStudents);
            const wb = XLSX.utils.book_new();

            const summaryData = [
                ["Thống kê ngày", formatDate(selectedDate)], ["Lớp", selectedClass === 'all' ? 'Tất cả' : selectedClass], [],
                ["Hạng mục", "Sáng", "Chiều"],
                ["Có mặt", stats.morning.present, stats.afternoon.present],
                ["Đi muộn", stats.morning.late, stats.afternoon.late],
                ["Vắng KP", stats.morning.absent_unexcused, stats.afternoon.absent_unexcused],
                ["Vắng CP", stats.morning.absent_excused, stats.afternoon.absent_excused],
                ["Tổng vắng", stats.morning.absent_total, stats.afternoon.absent_total]
            ];
            const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
            ws1['!cols'] = [{ wch: 25 }, { wch: 10 }, { wch: 10 }];
            XLSX.utils.book_append_sheet(wb, ws1, "Tổng quan");

            const dayRecords = window.attendanceRecords[selectedDate] || {};
            const detailData = filteredStudents.map((s, i) => {
                const record = dayRecords[s.id] || {};
                return {
                    'STT': i + 1, 'Họ và tên': s.name, 'Lớp': s.class,
                    'Trạng thái Sáng': getStatusText(record.morning?.status || 'present', true),
                    'Trạng thái Chiều': getStatusText(record.afternoon?.status || 'present', true)
                };
            });
            const ws2 = XLSX.utils.json_to_sheet(detailData);
            ws2['!cols'] = [{ wch: 5 }, { wch: 25 }, { wch: 10 }, { wch: 15 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, ws2, "Chi tiết");

            XLSX.writeFile(wb, `Thong_ke_ngay_${selectedDate}_${selectedClass}.xlsx`);
        }

        window.exportMonthlyStatsToExcel = function() {
            if (!checkAdminPassword()) return;
            const selectedMonth = document.getElementById('monthlyStatsDate').value;
            const [year, month] = selectedMonth.split('-');
            const stats = calculateMonthlyStats(year, month);
            const wb = XLSX.utils.book_new();

            const summaryData = [
                ["Thống kê tháng", `${month}/${year}`], [],
                ["Hạng mục", "Tổng số buổi"],
                ["Tổng buổi có mặt", stats.totalPresent],
                ["Tổng buổi đi muộn", stats.totalLate],
                ["Tổng buổi vắng KP", stats.totalAbsentUnexcused],
                ["Tổng buổi vắng CP", stats.totalAbsentExcused]
            ];
            const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
            ws1['!cols'] = [{ wch: 35 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, ws1, "Tổng quan tháng");

            const detailData = Object.values(stats.studentData).map((data, i) => ({
                'STT': i + 1, 'Họ và tên': data.student.name, 'Lớp': data.student.class,
                'Số buổi có mặt': data.present,
                'Số buổi đi muộn': data.late,
                'Số buổi vắng KP': data.absent_unexcused,
                'Số buổi vắng CP': data.absent_excused
            }));
            const ws2 = XLSX.utils.json_to_sheet(detailData);
            ws2['!cols'] = [{ wch: 5 }, { wch: 25 }, { wch: 10 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, ws2, "Chi tiết tháng");

            XLSX.writeFile(wb, `Thong_ke_thang_${month}_${year}.xlsx`);
        }
        
        // --- Dummy functions for student management to avoid errors ---
        // (Replace these with your actual, unchanged functions)
        window.addStudent = function() { console.log("addStudent called"); if(!checkAdminPassword()) return; /* ... your original code ... */ };
        window.deleteStudent = function(id) { console.log("deleteStudent called for", id); if(!checkAdminPassword()) return; /* ... your original code ... */ };
        window.editStudent = function(id) { console.log("editStudent called for", id); if(!checkAdminPassword()) return; /* ... your original code ... */ };
        window.importStudentsFromExcel = function() { console.log("importStudentsFromExcel called"); if(!checkAdminPassword()) return; /* ... your original code ... */ };
        window.downloadExcelTemplate = function() { console.log("downloadExcelTemplate called"); /* ... your original code ... */ };
        window.handleExcelUpload = function(event) { console.log("handleExcelUpload called"); /* ... your original code ... */ };
        window.deleteSelectedStudents = function() { if(!checkAdminPassword()) return; /* ... your original code ... */};
        window.toggleSelectAll = function() { /* ... your original code ... */};


    </script>
</body>
</html>
