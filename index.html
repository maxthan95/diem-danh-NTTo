<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ph·∫ßn m·ªÅm ƒëi·ªÉm danh h·ªçc sinh (S√°ng/Chi·ªÅu)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* General styling for the entire page */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px; /* Reduced padding for mobile */
        }

        /* Main container for the application */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* Header section */
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px; /* Adjusted padding */
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2rem; /* Adjusted font size */
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1rem; /* Adjusted font size */
            opacity: 0.9;
        }
        
        #app-id-container {
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-top: 15px;
            display: inline-block;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        #app-id-container span {
            font-weight: bold;
            color: #fff;
        }


        /* Tab navigation */
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            flex-wrap: wrap; /* Allow tabs to wrap on small screens */
        }

        .tab {
            flex: 1 1 auto; /* Allow tabs to grow and shrink */
            padding: 15px 10px; /* Adjusted padding */
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem; /* Adjusted font size */
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
            text-align: center;
        }

        .tab.active {
            background: white;
            color: #4facfe;
            border-bottom: 3px solid #4facfe;
        }

        .tab:hover:not(.active) {
            background: #e9ecef;
            color: #495057;
        }

        /* Content for each tab */
        .tab-content {
            display: none;
            padding: 20px; /* Adjusted padding */
        }

        .tab-content.active {
            display: block;
        }

        /* Styling for form sections */
        .form-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px; /* Adjusted padding */
            margin-bottom: 25px;
            border-left: 4px solid #4facfe;
        }

        .form-section h3 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Adjusted minmax */
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
            width: 100%; /* Ensure full width */
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        /* General button styling */
        .btn {
            padding: 12px 20px; /* Adjusted padding */
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center; /* Center content */
            gap: 8px;
            width: 100%; /* Make buttons full width on mobile */
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }


        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
        }
        
        /* Student list styling */
        .student-list {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .student-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 15px 20px;
        }
        
        .student-list-header h3 {
            margin: 0;
            font-size: 1.3rem;
        }
        
        .student-list-header .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .student-item {
            padding: 15px; /* Adjusted padding */
            border-bottom: 1px solid #e9ecef;
            display: grid;
            grid-template-columns: auto 1fr; /* Checkbox and content */
            gap: 15px; 
            align-items: center;
            transition: all 0.3s ease;
        }

        .student-item:hover {
            background: #f8f9fa;
        }
        
        .student-item-content {
            display: grid;
            grid-template-columns: 1fr; /* Single column layout for mobile */
            gap: 15px; /* Gap between info and controls */
            align-items: center;
        }

        .student-info {
            display: grid;
            grid-template-columns: 1fr; /* Single column for details */
            gap: 10px; /* Adjusted gap */
        }
        
        .student-detail {
            display: flex;
            flex-direction: column;
        }

        .student-detail strong {
            color: #495057;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .student-detail span {
            color: #6c757d;
            font-size: 1rem;
        }
        
        .daily-stats-statuses {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }


        /* Attendance controls and status styling */
        .attendance-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center; /* Center buttons on mobile */
        }
        
        .attendance-controls .btn {
            flex: 1 1 100px; /* Allow buttons to grow and shrink */
        }

        .session-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 10px;
        }
        
        .session-selector .btn {
            flex: 1;
            background-color: #f8f9fa;
            color: #495057;
            border: 2px solid #dee2e6;
        }
        .session-selector .btn.active {
            background: #4facfe;
            color: white;
            border-color: #4facfe;
            box-shadow: 0 4px 10px rgba(79, 172, 254, 0.3);
        }


        .attendance-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            border: 2px solid transparent;
            text-align: center;
        }

        .status-present { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .status-late { background: #fff3cd; color: #856404; border-color: #ffeaa7; }
        .status-absent-unexcused { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .status-absent-excused { background: #e2e3e5; color: #383d41; border-color: #d6d8db; }
        .status-na { background: #f0f0f0; color: #6c757d; border-color: #ccc; }


        /* Quick actions bar */
        .quick-actions {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .quick-actions .btn {
             flex: 1 1 150px; /* Responsive buttons */
        }

        /* Statistics grid and cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); /* Adjusted minmax */
            gap: 10px; /* Adjusted gap */
            margin-bottom: 25px;
        }

        .stats-card {
            background: white;
            border-radius: 10px;
            padding: 10px; /* Adjusted padding */
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border-left: 4px solid #4facfe;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
        }

        .stats-card.active-filter {
            border-left-color: #007bff;
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.3);
            transform: translateY(-2px);
        }

        .stats-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .stats-card h4 { 
            color: #495057; 
            margin-bottom: 8px; 
            font-size: 0.75rem; 
            height: 2.5em; /* Fixed height */
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.2;
        }
        .stats-card .number { 
            font-size: 1.7rem; 
            font-weight: bold; 
            color: #4facfe; 
        }

        /* Date filter section */
        .date-filter { background: white; border-radius: 10px; padding: 20px; margin-bottom: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .filter-row { display: grid; grid-template-columns: 1fr; gap: 15px; align-items: end; } /* Single column by default */
        
        /* Empty state for lists */
        .empty-state { text-align: center; padding: 60px 20px; color: #6c757d; }
        .empty-state h3 { margin-bottom: 10px; color: #495057; }
        
        /* --- Desktop and Tablet Styles --- */
        @media (min-width: 768px) {
             body {
                padding: 20px; /* Restore padding for larger screens */
            }
            .header h1 {
                font-size: 2.5rem; /* Restore font size */
            }
             .header p {
                font-size: 1.1rem; /* Restore font size */
            }
            .tab {
                font-size: 1rem; /* Restore font size */
                 padding: 15px 20px; /* Restore padding */
            }
            .tab-content, .form-section {
                 padding: 30px; /* Restore padding */
            }
            .btn {
                width: auto; /* Buttons are not full width on desktop */
            }
            .filter-row {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Multi-column layout */
            }
            .student-item-content {
                 grid-template-columns: 1fr auto; /* Two columns for info and controls */
                 gap: 20px;
            }
            .student-info {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Responsive grid for info */
                gap: 15px;
            }
             .attendance-controls {
                justify-content: flex-end; /* Align buttons to the right */
            }
            .attendance-controls .btn {
                 flex-grow: 0; /* Prevent buttons from growing too large */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Ph·∫ßn m·ªÅm ƒëi·ªÉm danh h·ªçc sinh</h1>
            <p>C·ªông t√°c ƒëi·ªÉm danh S√°ng/Chi·ªÅu</p>
            <div id="app-id-container">
                M√£ chia s·∫ª (App ID): <span id="appIdDisplay">ƒêang t·∫£i...</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('students')">üë• Qu·∫£n l√Ω h·ªçc sinh</button>
            <button class="tab" onclick="showTab('attendance')">üìù ƒêi·ªÉm danh</button>
            <button class="tab" onclick="showTab('daily-stats')">üìä Th·ªëng k√™ h√†ng ng√†y</button>
            <button class="tab" onclick="showTab('monthly-stats')">üìà Th·ªëng k√™ h√†ng th√°ng</button>
        </div>

        <div id="students" class="tab-content active">
            <div class="form-section">
                <h3>üìÅ Nh·∫≠p danh s√°ch t·ª´ Excel</h3>
                <div class="form-row">
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Ch·ªçn file Excel (*.xlsx, *.xls)</label>
                        <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="handleExcelUpload(event)">
                        <small style="color: #6c757d; margin-top: 5px; display: block;">
                            üìã File Excel c·∫ßn c√≥ c√°c c·ªôt: <strong>H·ªç v√† t√™n, L·ªõp, Ng√†y sinh, Gi·ªõi t√≠nh, Lo·∫°i h·ªçc sinh</strong>
                        </small>
                    </div>
                </div>
                <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                    <button class="btn btn-success" onclick="importStudentsFromExcel()">
                        üì• Nh·∫≠p t·ª´ Excel
                    </button>
                    <button class="btn btn-info" onclick="downloadExcelTemplate()">
                        üìÑ T·∫£i m·∫´u Excel
                    </button>
                    <span id="importStatus" style="color: #28a745; font-weight: bold;"></span>
                </div>
            </div>

            <div class="form-section">
                <h3>‚ûï Th√™m h·ªçc sinh m·ªõi</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>H·ªç v√† t√™n</label>
                        <input type="text" id="studentName" placeholder="Nh·∫≠p h·ªç v√† t√™n h·ªçc sinh">
                    </div>
                    <div class="form-group">
                        <label>L·ªõp</label>
                        <input type="text" id="studentClass" placeholder="V√≠ d·ª•: 6A1">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ng√†y sinh</label>
                        <input type="date" id="studentBirthDate">
                    </div>
                    <div class="form-group">
                        <label>Gi·ªõi t√≠nh</label>
                        <select id="studentGender">
                            <option value="">-- Ch·ªçn gi·ªõi t√≠nh --</option>
                            <option value="Nam">Nam</option>
                            <option value="N·ªØ">N·ªØ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Lo·∫°i h·ªçc sinh</label>
                        <select id="studentType">
                            <option value="">-- Ch·ªçn lo·∫°i --</option>
                            <option value="B√°n tr√∫">B√°n tr√∫</option>
                            <option value="Kh√¥ng b√°n tr√∫">Kh√¥ng b√°n tr√∫</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addStudent()">‚ûï Th√™m h·ªçc sinh</button>
            </div>

            <div class="form-section" style="border-left-color: #56ab2f;">
                <h3 style="margin-bottom: 15px;">L·ªçc danh s√°ch h·ªçc sinh</h3>
                <div class="form-group">
                    <label for="studentManagementClassFilter">Ch·ªçn l·ªõp ƒë·ªÉ hi·ªÉn th·ªã v√† ch·ªânh s·ª≠a</label>
                    <select id="studentManagementClassFilter" onchange="displayStudents()"></select>
                </div>
            </div>

            <div class="student-list">
                <div class="student-list-header">
                    <h3>üìã Danh s√°ch h·ªçc sinh</h3>
                    <div class="header-controls">
                        <label>
                            <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this.checked)" style="transform: scale(1.5);">
                            Ch·ªçn t·∫•t c·∫£
                        </label>
                        <button class="btn btn-danger" style="width: auto; padding: 8px 15px;" onclick="deleteSelectedStudents()">üóëÔ∏è X√≥a ƒë√£ ch·ªçn</button>
                    </div>
                </div>
                <div id="studentsList"></div>
            </div>
        </div>

        <div id="attendance" class="tab-content">
            <div class="quick-actions">
                <button class="btn btn-success" onclick="markAllPresent()">‚úÖ T·∫•t c·∫£ c√≥ m·∫∑t (bu·ªïi hi·ªán t·∫°i)</button>
                <button class="btn btn-info" onclick="exportAttendanceToExcel()">üìÅ Xu·∫•t Excel</button>
            </div>

            <div class="date-filter">
                <h4>üìÖ L·ªçc v√† ƒëi·ªÉm danh</h4>
                <div class="filter-row">
                    <div class="form-group">
                        <label for="attendanceDate">Ch·ªçn ng√†y ƒëi·ªÉm danh</label>
                        <input type="date" id="attendanceDate" onchange="loadAttendanceForDate()">
                    </div>
                    <div class="form-group">
                        <label for="classFilter">Ch·ªçn l·ªõp</label>
                        <select id="classFilter" onchange="loadAttendanceForDate()"></select>
                    </div>
                </div>
                <div class="session-selector">
                    <button id="session-morning" class="btn active" onclick="selectSession('morning')">‚òÄÔ∏è Bu·ªïi S√°ng</button>
                    <button id="session-afternoon" class="btn" onclick="selectSession('afternoon')">üåô Bu·ªïi Chi·ªÅu</button>
                </div>
            </div>

            <div class="student-list">
                <h3 id="attendanceListTitle">üë®‚Äçüéì ƒêi·ªÉm danh h·ªçc sinh</h3>
                <div id="attendanceList"></div>
            </div>
        </div>

        <div id="daily-stats" class="tab-content">
            <div class="date-filter">
                <div class="filter-row">
                    <div class="form-group">
                        <label>Ch·ªçn ng√†y th·ªëng k√™</label>
                        <input type="date" id="dailyStatsDate" onchange="loadDailyStats()">
                    </div>
                    <div class="form-group">
                        <label for="dailyStatsClassFilter">Ch·ªçn l·ªõp</label>
                        <select id="dailyStatsClassFilter" onchange="loadDailyStats()"></select>
                    </div>
                    <div class="form-group">
                         <button class="btn btn-info" onclick="loadDailyStats()">üìä Xem th·ªëng k√™</button>
                    </div>
                     <div class="form-group">
                        <button class="btn btn-success" onclick="exportDailyStatsToExcel()">üìÅ Xu·∫•t Excel</button>
                    </div>
                </div>
            </div>

            <div class="stats-grid" id="dailyStatsGrid"></div>
            <div class="student-list" id="dailyStatsList"></div>
        </div>

        <div id="monthly-stats" class="tab-content">
            <div class="date-filter">
                <div class="filter-row">
                    <div class="form-group">
                        <label>Ch·ªçn th√°ng/nƒÉm</label>
                        <input type="month" id="monthlyStatsDate" onchange="loadMonthlyStats()">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-info" onclick="loadMonthlyStats()">üìà Xem th·ªëng k√™</button>
                    </div>
                     <div class="form-group">
                        <button class="btn btn-success" onclick="exportMonthlyStatsToExcel()">üìÅ Xu·∫•t Excel</button>
                    </div>
                </div>
            </div>

            <div class="stats-grid" id="monthlyStatsGrid"></div>
            <div class="student-list" id="monthlyStatsList"></div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- GLOBAL VARIABLES ---
        const appId = 'diem-danh-NTTo';
        const firebaseConfig = {
    		apiKey: "AIzaSyBbNvKLgj8QdM22rqxnS65cJGSF5wNUIJE",
    		authDomain: "diem-danh-20xx.firebaseapp.com",
    		projectId: "diem-danh-20xx",
    		storageBucket: "diem-danh-20xx.firebasestorage.app",
    		messagingSenderId: "474588160188",
    		appId: "1:474588160188:web:37a1b187369ff47e56f0b9",
    		measurementId: "G-CYHW7NZKGM"
  		};
        
        let db;
        let auth;
        let dataDocRef;

        // --- DATA MANAGEMENT ---
        window.students = [];
        window.attendanceRecords = {};
        window.excelData = [];

        // --- FIREBASE INITIALIZATION ---
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            document.getElementById('appIdDisplay').textContent = appId;
        } catch (e) {
            console.error("Error initializing Firebase:", e);
            alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn c∆° s·ªü d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.");
        }

        // --- ASYNC AUTH & DATA LISTENER SETUP ---
        async function initializeFirebase() {
            try {
                await signInAnonymously(auth);
                const user = auth.currentUser;
                if (!user) {
                    throw new Error("Authentication failed, user is null.");
                }

                dataDocRef = doc(db, "artifacts", appId, "public", "data", "attendance", "mainDoc");

                onSnapshot(dataDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        window.students = data.students || [];
                        window.attendanceRecords = data.attendanceRecords || {};
                    } else {
                        window.students = [];
                        window.attendanceRecords = {};
                    }
                    window.sortStudents();
                    updateAllUI();
                }, (error) => {
                    console.error("Error listening to data:", error);
                    alert("M·∫•t k·∫øt n·ªëi v·ªõi d·ªØ li·ªáu th·ªùi gian th·ª±c.");
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                alert("Kh√¥ng th·ªÉ kh·ªüi t·∫°o ·ª©ng d·ª•ng ho·∫∑c k·∫øt n·ªëi d·ªØ li·ªáu.");
            }
        }
        
        initializeFirebase();

        // --- UI UPDATE FUNCTION ---
        function updateAllUI() {
            window.populateClassFilter();
            window.displayStudents();
            window.loadAttendanceForDate();
            window.loadDailyStats();
            window.loadMonthlyStats();
        }

        // --- DATA PERSISTENCE ---
        let saveTimeout = null;
        async function saveData() {
            if (!dataDocRef) {
                console.error("Firestore document reference not initialized.");
                return;
            }
            const dataToSave = {
                students: window.students,
                attendanceRecords: window.attendanceRecords,
            };
            try {
                await setDoc(dataDocRef, dataToSave);
            } catch (error) {
                console.error("Error saving data to Firestore:", error);
            }
        }

        window.autoSave = function() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveData, 2000);
        }
    </script>
    
    <script>
        // --- GLOBAL STATE for UI ---
        let currentSession = 'morning';
        let dailyStatsFilterStatus = 'all';

        // --- INITIALIZATION ---
        window.onload = function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendanceDate').value = today;
            document.getElementById('dailyStatsDate').value = today;
            document.getElementById('monthlyStatsDate').value = today.substring(0, 7);
        };

        // --- TAB & SESSION MANAGEMENT ---
        window.showTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }
        
        window.selectSession = function(session) {
            currentSession = session;
            document.getElementById('session-morning').classList.toggle('active', session === 'morning');
            document.getElementById('session-afternoon').classList.toggle('active', session === 'afternoon');
            loadAttendanceForDate();
        }

        // --- ADMIN PASSWORD ---
        function checkAdminPassword() {
            const adminPassword = "admin"; 
            const enteredPassword = prompt("Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u qu·∫£n tr·ªã:", "");
            if (enteredPassword === adminPassword) return true;
            if (enteredPassword !== null) alert("M·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c!");
            return false;
        }

        // --- STUDENT MANAGEMENT & HELPERS ---
        function getSortableName(name) {
            const parts = name.trim().split(/\s+/);
            const lastName = parts.pop() || '';
            const firstName = parts.join(' ');
            return { lastName, firstName };
        }

        window.sortStudents = function() {
            window.students.sort((a, b) => {
                const classCompare = a.class.localeCompare(b.class, 'vi');
                if (classCompare !== 0) return classCompare;
                const nameA = getSortableName(a.name);
                const nameB = getSortableName(b.name);
                const lastNameCompare = nameA.lastName.localeCompare(nameB.lastName, 'vi');
                return lastNameCompare !== 0 ? lastNameCompare : nameA.firstName.localeCompare(nameB.firstName, 'vi');
            });
        }
        
        window.addStudent = function() {
            if (!checkAdminPassword()) return;
            const name = document.getElementById('studentName').value.trim();
            const studentClass = document.getElementById('studentClass').value.trim();
            const birthDate = document.getElementById('studentBirthDate').value;
            const gender = document.getElementById('studentGender').value;
            const type = document.getElementById('studentType').value;
            if (!name || !studentClass || !birthDate || !gender || !type) {
                alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                return;
            }
            window.students.push({ id: Date.now() + Math.random(), name, class: studentClass, birthDate, gender, type });
            window.sortStudents();
            ['studentName', 'studentClass', 'studentBirthDate', 'studentGender', 'studentType'].forEach(id => document.getElementById(id).value = '');
            window.autoSave();
        };

        window.deleteStudent = function(id) {
            if (!checkAdminPassword()) return;
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a h·ªçc sinh n√†y?')) {
                window.students = window.students.filter(s => s.id !== id);
                window.autoSave();
            }
        };
        
        window.editStudent = function(id) {
            if (!checkAdminPassword()) return;
            const student = window.students.find(s => s.id === id);
            if (!student) return;
            document.getElementById('studentName').value = student.name;
            document.getElementById('studentClass').value = student.class;
            document.getElementById('studentBirthDate').value = student.birthDate;
            document.getElementById('studentGender').value = student.gender;
            document.getElementById('studentType').value = student.type;
            window.students = window.students.filter(s => s.id !== id);
            window.autoSave();
            alert('Th√¥ng tin h·ªçc sinh ƒë√£ ƒë∆∞·ª£c t·∫£i l√™n form. Ch·ªânh s·ª≠a v√† nh·∫•n "Th√™m h·ªçc sinh" ƒë·ªÉ l∆∞u l·∫°i.');
            document.querySelector('#students .form-section').scrollIntoView({ behavior: 'smooth' });
        };
        
        window.toggleSelectAll = function(checked) {
            document.querySelectorAll('#studentsList .student-checkbox').forEach(cb => cb.checked = checked);
        };

        window.deleteSelectedStudents = function() {
            if (!checkAdminPassword()) return;
            const selectedIds = Array.from(document.querySelectorAll('#studentsList .student-checkbox:checked')).map(cb => parseFloat(cb.dataset.id));
            if (selectedIds.length === 0) {
                alert('Vui l√≤ng ch·ªçn h·ªçc sinh ƒë·ªÉ x√≥a.');
                return;
            }
            if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ${selectedIds.length} h·ªçc sinh ƒë√£ ch·ªçn?`)) {
                window.students = window.students.filter(s => !selectedIds.includes(s.id));
                window.autoSave();
            }
        };

        window.displayStudents = function() {
            const container = document.getElementById('studentsList');
            const classFilterElement = document.getElementById('studentManagementClassFilter');
            const selectedClass = classFilterElement ? classFilterElement.value : 'all';

            document.getElementById('selectAllCheckbox').checked = false; 

            let studentsToDisplay = window.students;
            if (selectedClass && selectedClass !== 'all') {
                studentsToDisplay = window.students.filter(s => s.class === selectedClass);
            }

            if (studentsToDisplay.length === 0) {
                container.innerHTML = `<div class="empty-state"><h3>Ch∆∞a c√≥ h·ªçc sinh n√†o${selectedClass !== 'all' ? ' trong l·ªõp n√†y' : ''}.</h3></div>`;
                return;
            }
            container.innerHTML = studentsToDisplay.map(student => `
                <div class="student-item">
                    <input type="checkbox" class="student-checkbox" data-id="${student.id}" style="transform: scale(1.5);">
                    <div class="student-item-content">
                        <div class="student-info">
                            <div class="student-detail"><strong>H·ªç v√† t√™n:</strong><span>${student.name}</span></div>
                            <div class="student-detail"><strong>L·ªõp:</strong><span>${student.class}</span></div>
                            <div class="student-detail"><strong>Ng√†y sinh:</strong><span>${formatDate(student.birthDate)}</span></div>
                            <div class="student-detail"><strong>Lo·∫°i:</strong><span>${student.type}</span></div>
                        </div>
                        <div class="attendance-controls">
                            <button class="btn" onclick="editStudent(${student.id})">‚úèÔ∏è S·ª≠a</button>
                            <button class="btn btn-danger" onclick="deleteStudent(${student.id})">üóëÔ∏è X√≥a</button>
                        </div>
                    </div>
                </div>`).join('');
        };
        
        // --- EXCEL HANDLING ---
        window.handleExcelUpload = function(event) {
             const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false });
                    
                    if (jsonData.length < 2) { alert('File Excel kh√¥ng c√≥ d·ªØ li·ªáu!'); return; }
                    
                    const headers = jsonData[0].map(h => String(h || '').trim().toLowerCase());
                    const columnMap = {
                        name: headers.findIndex(h => ['h·ªç v√† t√™n', 'h·ªç t√™n'].some(v => h.includes(v))),
                        class: headers.findIndex(h => h.includes('l·ªõp')),
                        birthDate: headers.findIndex(h => h.includes('ng√†y sinh')),
                        gender: headers.findIndex(h => h.includes('gi·ªõi t√≠nh')),
                        type: headers.findIndex(h => ['lo·∫°i h·ªçc sinh', 'lo·∫°i'].some(v => h.includes(v)))
                    };
                    
                    if (Object.values(columnMap).some(index => index === -1)) {
                        alert('File Excel thi·∫øu c√°c c·ªôt b·∫Øt bu·ªôc: H·ªç v√† t√™n, L·ªõp, Ng√†y sinh, Gi·ªõi t√≠nh, Lo·∫°i h·ªçc sinh');
                        return;
                    }
                    
                    window.excelData = jsonData.slice(1).map(row => {
                        const name = String(row[columnMap.name] || '').trim();
                        if (!name) return null;
                        return {
                            name,
                            class: String(row[columnMap.class] || '').trim(),
                            birthDate: formatDate(row[columnMap.birthDate]),
                            gender: String(row[columnMap.gender] || '').trim(),
                            type: String(row[columnMap.type] || '').trim()
                        };
                    }).filter(Boolean);
                    
                    document.getElementById('importStatus').textContent = `‚úÖ ƒê√£ t·∫£i ${window.excelData.length} h·ªçc sinh. Nh·∫•n "Nh·∫≠p" ƒë·ªÉ th√™m.`;
                } catch (error) {
                    alert('C√≥ l·ªói khi ƒë·ªçc file Excel. Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng file!');
                }
            };
            reader.readAsArrayBuffer(file);
        };
        window.importStudentsFromExcel = function() {
            if (!checkAdminPassword() || window.excelData.length === 0) return;
            let addedCount = 0;
            window.excelData.forEach(studentData => {
                if (!window.students.some(s => s.name.toLowerCase() === studentData.name.toLowerCase() && s.class.toLowerCase() === studentData.class.toLowerCase())) {
                    window.students.push({ id: Date.now() + Math.random(), ...studentData });
                    addedCount++;
                }
            });
            window.sortStudents();
            window.autoSave();
            document.getElementById('excelFile').value = '';
            window.excelData = [];
            document.getElementById('importStatus').textContent = '';
            alert(`‚úÖ Nh·∫≠p th√†nh c√¥ng ${addedCount} h·ªçc sinh.`);
        };
        window.downloadExcelTemplate = function() {
            const templateData = [['H·ªç v√† t√™n', 'L·ªõp', 'Ng√†y sinh', 'Gi·ªõi t√≠nh', 'Lo·∫°i h·ªçc sinh']];
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            ws['!cols'] = [{ wch: 25 }, { wch: 10 }, { wch: 15 }, { wch: 12 }, { wch: 18 }];
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Danh s√°ch");
            XLSX.writeFile(wb, "Mau_danh_sach_hoc_sinh.xlsx");
        };

        // --- ATTENDANCE TRACKING ---
        window.populateClassFilter = function() {
            const filters = [
                document.getElementById('classFilter'), 
                document.getElementById('dailyStatsClassFilter'),
                document.getElementById('studentManagementClassFilter')
            ];
            const uniqueClasses = [...new Set(window.students.map(s => s.class))].sort((a,b) => a.localeCompare(b, 'vi'));
            const optionsHtml = '<option value="all">T·∫•t c·∫£ c√°c l·ªõp</option>' + uniqueClasses.map(c => `<option value="${c}">${c}</option>`).join('');
            filters.forEach(filter => {
                if(filter) {
                    const currentVal = filter.value;
                    filter.innerHTML = optionsHtml;
                    if ([...filter.options].some(o => o.value === currentVal)) filter.value = currentVal;
                }
            });
        }

        window.loadAttendanceForDate = function() {
            const selectedDate = document.getElementById('attendanceDate').value;
            const selectedClass = document.getElementById('classFilter').value;
            const container = document.getElementById('attendanceList');
            const title = document.getElementById('attendanceListTitle');
            let filteredStudents = (selectedClass && selectedClass !== 'all') ? window.students.filter(s => s.class === selectedClass) : window.students;
            
            title.textContent = `üë®‚Äçüéì ƒêi·ªÉm danh ${selectedClass === 'all' ? 't·∫•t c·∫£' : 'l·ªõp ' + selectedClass} - Bu·ªïi ${currentSession === 'morning' ? 'S√°ng' : 'Chi·ªÅu'}`;
            
            if (filteredStudents.length === 0) {
                container.innerHTML = `<div class="empty-state"><h3>Kh√¥ng c√≥ h·ªçc sinh n√†o.</h3></div>`;
                return;
            }

            const dayRecords = window.attendanceRecords[selectedDate] || {};
            container.innerHTML = filteredStudents.map(student => {
                const status = dayRecords[student.id]?.[currentSession]?.status || 'present';
                return `
                    <div class="student-item">
                         <div class="student-item-content">
                            <div class="student-info">
                                <div class="student-detail"><strong>H·ªç v√† t√™n:</strong><span>${student.name}</span></div>
                                <div class="student-detail"><strong>L·ªõp:</strong><span>${student.class}</span></div>
                                <div class="student-detail"><strong>Tr·∫°ng th√°i:</strong>
                                    <span class="attendance-status ${getStatusClass(status)}">${getStatusText(status)}</span>
                                </div>
                            </div>
                            <div class="attendance-controls">
                                <button class="btn" style="background-color:#28a745; color:white" onclick="markAttendance(${student.id}, 'present')">‚úÖ C√≥ m·∫∑t</button>
                                <button class="btn" style="background: #ffc107; color: black;" onclick="markAttendance(${student.id}, 'late')">‚è∞ Mu·ªôn</button>
                                <button class="btn" style="background: #6c757d; color: white;" onclick="markAttendance(${student.id}, 'absent_excused')">üìã V·∫Øng CP</button>
                                <button class="btn" style="background: #dc3545; color: white;" onclick="markAttendance(${student.id}, 'absent_unexcused')">‚ùå V·∫Øng KP</button>
                            </div>
                        </div>
                    </div>`;
            }).join('');
        }

        window.markAttendance = function(studentId, status) {
            const selectedDate = document.getElementById('attendanceDate').value;
            if (!window.attendanceRecords[selectedDate]) window.attendanceRecords[selectedDate] = {};
            if (!window.attendanceRecords[selectedDate][studentId]) window.attendanceRecords[selectedDate][studentId] = {};
            
            window.attendanceRecords[selectedDate][studentId][currentSession] = { status, timestamp: new Date().toISOString() };
            window.autoSave();
        }

        window.markAllPresent = function() {
            if (!checkAdminPassword()) return;
            const selectedDate = document.getElementById('attendanceDate').value;
            const selectedClass = document.getElementById('classFilter').value;
            let studentsToMark = (selectedClass && selectedClass !== 'all') ? window.students.filter(s => s.class === selectedClass) : window.students;

            if (studentsToMark.length === 0) return;
            if (!window.attendanceRecords[selectedDate]) window.attendanceRecords[selectedDate] = {};
            
            const timestamp = new Date().toISOString();
            studentsToMark.forEach(student => {
                if (!window.attendanceRecords[selectedDate][student.id]) window.attendanceRecords[selectedDate][student.id] = {};
                window.attendanceRecords[selectedDate][student.id][currentSession] = { status: 'present', timestamp };
            });
            
            window.autoSave();
            alert(`ƒê√£ ƒëi·ªÉm danh t·∫•t c·∫£ ${studentsToMark.length} h·ªçc sinh c√≥ m·∫∑t cho bu·ªïi ${currentSession === 'morning' ? 'S√°ng' : 'Chi·ªÅu'}!`);
        }

        // --- STATISTICS ---
        function createSessionStatCounter() {
            return {
                present: 0, late: 0,
                absent_unexcused: 0, absent_excused: 0, absent_total: 0,
                boarding_absent_unexcused: 0, boarding_absent_excused: 0
            };
        }

        function calculateDayStats(dayRecords, studentList) {
            const stats = {
                total: studentList.length,
                boarding_total: 0,
                morning: createSessionStatCounter(),
                afternoon: createSessionStatCounter()
            };

            studentList.forEach(student => {
                const isBoarding = student.type === 'B√°n tr√∫';
                if (isBoarding) stats.boarding_total++;
                const record = dayRecords[student.id] || {};

                ['morning', 'afternoon'].forEach(session => {
                    const status = record[session]?.status || 'present';
                    stats[session][status]++;
                    if (isBoarding) {
                        if (status === 'absent_unexcused') stats[session].boarding_absent_unexcused++;
                        if (status === 'absent_excused') stats[session].boarding_absent_excused++;
                    }
                });
            });

            ['morning', 'afternoon'].forEach(session => {
                stats[session].absent_total = stats[session].absent_unexcused + stats[session].absent_excused;
            });
            return stats;
        }

        window.filterDailyStatsByStatus = function(status) {
            dailyStatsFilterStatus = (dailyStatsFilterStatus === status) ? 'all' : status;
            loadDailyStats();
        }

        window.loadDailyStats = function() {
            const selectedDate = document.getElementById('dailyStatsDate').value;
            const selectedClass = document.getElementById('dailyStatsClassFilter').value;
            let filteredStudents = (selectedClass && selectedClass !== 'all') ? window.students.filter(s => s.class === selectedClass) : window.students;

            const stats = calculateDayStats(window.attendanceRecords[selectedDate] || {}, filteredStudents);
            const activeFilterClass = (status) => dailyStatsFilterStatus === status ? 'active-filter' : '';

            document.getElementById('dailyStatsGrid').innerHTML = `
                <div class="stats-card ${activeFilterClass('total')}" onclick="filterDailyStatsByStatus('total')"><h4>T·ªïng HS</h4><div class="number">${stats.total}</div></div>
                <div class="stats-card ${activeFilterClass('boarding_total')}" onclick="filterDailyStatsByStatus('boarding_total')"><h4>T·ªïng B√°n Tr√∫</h4><div class="number">${stats.boarding_total}</div></div>
                <div class="stats-card ${activeFilterClass('absent_unexcused_morning')}" onclick="filterDailyStatsByStatus('absent_unexcused_morning')"><h4>V·∫Øng KP S√°ng</h4><div class="number" style="color: #dc3545;">${stats.morning.absent_unexcused}</div></div>
                <div class="stats-card ${activeFilterClass('absent_excused_morning')}" onclick="filterDailyStatsByStatus('absent_excused_morning')"><h4>V·∫Øng CP S√°ng</h4><div class="number" style="color: #6c757d;">${stats.morning.absent_excused}</div></div>
                <div class="stats-card ${activeFilterClass('boarding_absent_unexcused_morning')}" onclick="filterDailyStatsByStatus('boarding_absent_unexcused_morning')"><h4>BT V·∫Øng KP S√°ng</h4><div class="number" style="color: #dc3545;">${stats.morning.boarding_absent_unexcused}</div></div>
                <div class="stats-card ${activeFilterClass('boarding_absent_excused_morning')}" onclick="filterDailyStatsByStatus('boarding_absent_excused_morning')"><h4>BT V·∫Øng CP S√°ng</h4><div class="number" style="color: #6c757d;">${stats.morning.boarding_absent_excused}</div></div>
                <div class="stats-card ${activeFilterClass('absent_unexcused_afternoon')}" onclick="filterDailyStatsByStatus('absent_unexcused_afternoon')"><h4>V·∫Øng KP Chi·ªÅu</h4><div class="number" style="color: #dc3545;">${stats.afternoon.absent_unexcused}</div></div>
                <div class="stats-card ${activeFilterClass('absent_excused_afternoon')}" onclick="filterDailyStatsByStatus('absent_excused_afternoon')"><h4>V·∫Øng CP Chi·ªÅu</h4><div class="number" style="color: #6c757d;">${stats.afternoon.absent_excused}</div></div>
                <div class="stats-card ${activeFilterClass('boarding_absent_unexcused_afternoon')}" onclick="filterDailyStatsByStatus('boarding_absent_unexcused_afternoon')"><h4>BT V·∫Øng KP Chi·ªÅu</h4><div class="number" style="color: #dc3545;">${stats.afternoon.boarding_absent_unexcused}</div></div>
                <div class="stats-card ${activeFilterClass('boarding_absent_excused_afternoon')}" onclick="filterDailyStatsByStatus('boarding_absent_excused_afternoon')"><h4>BT V·∫Øng CP Chi·ªÅu</h4><div class="number" style="color: #6c757d;">${stats.afternoon.boarding_absent_excused}</div></div>
            `;
            
            const dayRecords = window.attendanceRecords[selectedDate] || {};
            let listToDisplay = filteredStudents;

            if (dailyStatsFilterStatus !== 'all' && dailyStatsFilterStatus !== 'total') {
                listToDisplay = filteredStudents.filter(student => {
                    const isBoarding = student.type === 'B√°n tr√∫';
                    const mStatus = dayRecords[student.id]?.morning?.status || 'present';
                    const aStatus = dayRecords[student.id]?.afternoon?.status || 'present';
                    switch (dailyStatsFilterStatus) {
                        case 'boarding_total': return isBoarding;
                        case 'absent_unexcused_morning': return mStatus === 'absent_unexcused';
                        case 'absent_excused_morning': return mStatus === 'absent_excused';
                        case 'boarding_absent_unexcused_morning': return isBoarding && mStatus === 'absent_unexcused';
                        case 'boarding_absent_excused_morning': return isBoarding && mStatus === 'absent_excused';
                        case 'absent_unexcused_afternoon': return aStatus === 'absent_unexcused';
                        case 'absent_excused_afternoon': return aStatus === 'absent_excused';
                        case 'boarding_absent_unexcused_afternoon': return isBoarding && aStatus === 'absent_unexcused';
                        case 'boarding_absent_excused_afternoon': return isBoarding && aStatus === 'absent_excused';
                        default: return false;
                    }
                });
            }

            document.getElementById('dailyStatsList').innerHTML = `<h3>Chi ti·∫øt ng√†y ${formatDate(selectedDate)}</h3>` + (listToDisplay.map(student => {
                const record = dayRecords[student.id] || {};
                const mStatus = record.morning?.status || 'present';
                const aStatus = record.afternoon?.status || 'present';
                return `
                    <div class="student-item">
                         <div class="student-item-content">
                            <div class="student-info">
                                <div class="student-detail"><strong>H·ªç v√† t√™n:</strong><span>${student.name}</span></div>
                                <div class="student-detail"><strong>L·ªõp:</strong><span>${student.class}</span></div>
                                <div class="student-detail"><strong>Tr·∫°ng th√°i:</strong>
                                    <div class="daily-stats-statuses">
                                        <span class="attendance-status ${getStatusClass(mStatus)}">S: ${getStatusText(mStatus, true)}</span>
                                        <span class="attendance-status ${getStatusClass(aStatus)}">C: ${getStatusText(aStatus, true)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
            }).join('') || `<div class="empty-state"><p>Kh√¥ng c√≥ h·ªçc sinh ph√π h·ª£p b·ªô l·ªçc.</p></div>`);
        }
        
        function calculateMonthlyStats(year, month) {
            const studentData = {};
            window.students.forEach(s => {
                studentData[s.id] = { student: s, present: 0, late: 0, absent_unexcused: 0, absent_excused: 0 };
            });
            
            const totals = {
                morning: { absent_unexcused: 0, absent_excused: 0, boarding_absent_unexcused: 0, boarding_absent_excused: 0 },
                afternoon: { absent_unexcused: 0, absent_excused: 0, boarding_absent_unexcused: 0, boarding_absent_excused: 0 }
            };
            
            const daysInMonth = new Date(year, month, 0).getDate();
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month - 1, day);
                if (date.getDay() === 0 || date.getDay() === 6) continue;

                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayRecords = window.attendanceRecords[dateStr] || {};
                
                window.students.forEach(student => {
                    const isBoarding = student.type === 'B√°n tr√∫';
                    const record = dayRecords[student.id] || {};
                    
                    ['morning', 'afternoon'].forEach(session => {
                        const status = record[session]?.status || 'present';
                        if (studentData[student.id]) studentData[student.id][status]++;
                        if (status === 'absent_unexcused') {
                            totals[session].absent_unexcused++;
                            if (isBoarding) totals[session].boarding_absent_unexcused++;
                        }
                        if (status === 'absent_excused') {
                            totals[session].absent_excused++;
                            if (isBoarding) totals[session].boarding_absent_excused++;
                        }
                    });
                });
            }
            return { studentData, totals };
        }

        window.loadMonthlyStats = function() {
            const selectedMonth = document.getElementById('monthlyStatsDate').value;
            if (!selectedMonth) return;
            const [year, month] = selectedMonth.split('-');
            const stats = calculateMonthlyStats(year, month);

            document.getElementById('monthlyStatsGrid').innerHTML = `
                <div class="stats-card"><h4>V·∫Øng KP S√°ng</h4><div class="number" style="color: #dc3545;">${stats.totals.morning.absent_unexcused}</div></div>
                <div class="stats-card"><h4>V·∫Øng CP S√°ng</h4><div class="number" style="color: #6c757d;">${stats.totals.morning.absent_excused}</div></div>
                <div class="stats-card"><h4>BT V·∫Øng KP S√°ng</h4><div class="number" style="color: #dc3545;">${stats.totals.morning.boarding_absent_unexcused}</div></div>
                <div class="stats-card"><h4>BT V·∫Øng CP S√°ng</h4><div class="number" style="color: #6c757d;">${stats.totals.morning.boarding_absent_excused}</div></div>
                <div class="stats-card"><h4>V·∫Øng KP Chi·ªÅu</h4><div class="number" style="color: #dc3545;">${stats.totals.afternoon.absent_unexcused}</div></div>
                <div class="stats-card"><h4>V·∫Øng CP Chi·ªÅu</h4><div class="number" style="color: #6c757d;">${stats.totals.afternoon.absent_excused}</div></div>
                <div class="stats-card"><h4>BT V·∫Øng KP Chi·ªÅu</h4><div class="number" style="color: #dc3545;">${stats.totals.afternoon.boarding_absent_unexcused}</div></div>
                <div class="stats-card"><h4>BT V·∫Øng CP Chi·ªÅu</h4><div class="number" style="color: #6c757d;">${stats.totals.afternoon.boarding_absent_excused}</div></div>
            `;

            document.getElementById('monthlyStatsList').innerHTML = `<h3>T·ªïng h·ª£p c√°c bu·ªïi trong th√°ng ${month}/${year} (T2-T6)</h3>` + Object.values(stats.studentData).map(data => `
                <div class="student-item">
                    <div class="student-item-content">
                        <div class="student-info">
                            <div class="student-detail"><strong>H·ªç v√† t√™n:</strong><span>${data.student.name}</span></div>
                            <div class="student-detail"><strong>C√≥ m·∫∑t:</strong><span style="color: #28a745;">${data.present}</span></div>
                            <div class="student-detail"><strong>Mu·ªôn:</strong><span style="color: #ffc107;">${data.late}</span></div>
                            <div class="student-detail"><strong>V·∫Øng KP:</strong><span style="color: #dc3545;">${data.absent_unexcused}</span></div>
                            <div class="student-detail"><strong>V·∫Øng CP:</strong><span style="color: #6c757d;">${data.absent_excused}</span></div>
                        </div>
                    </div>
                </div>`).join('');
        }

        // --- UTILITY & HELPER FUNCTIONS ---
        function getStatusClass(status) {
            return { present: 'status-present', late: 'status-late', absent_unexcused: 'status-absent-unexcused', absent_excused: 'status-absent_excused' }[status] || 'status-present';
        }

        function getStatusText(status, short = false) {
            const text = { present: 'C√≥ m·∫∑t', late: 'Mu·ªôn', absent_unexcused: 'V·∫Øng KP', absent_excused: 'V·∫Øng CP' }[status] || 'C√≥ m·∫∑t';
            return short ? text : ( {present: '‚úÖ ', late: '‚è∞ ', absent_unexcused: '‚ùå ', absent_excused: 'üìã '}[status] || '‚úÖ ') + text;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                // Adjust for timezone to avoid date shifting
                const userTimezoneOffset = date.getTimezoneOffset() * 60000;
                const correctedDate = new Date(date.getTime() + userTimezoneOffset);
                return correctedDate.toLocaleDateString('vi-VN');
            } catch (e) {
                // Fallback for different date formats from Excel
                const parts = String(dateString).split(/[-/]/);
                if (parts.length === 3) {
                    // Assuming dd/mm/yyyy or dd-mm-yyyy
                    return `${parts[0].padStart(2, '0')}/${parts[1].padStart(2, '0')}/${parts[2]}`;
                }
                return dateString;
            }
        }
        
        function formatTimestamp(isoString) {
            if (!isoString) return '';
            return new Date(isoString).toLocaleString('vi-VN', { hour: '2-digit', minute: '2-digit' });
        }
        
        // --- EXPORT TO EXCEL ---
        window.exportAttendanceToExcel = function() {
            if (!checkAdminPassword()) return;
            const selectedDate = document.getElementById('attendanceDate').value;
            const dayRecords = window.attendanceRecords[selectedDate] || {};
            const data = window.students.map((s, i) => {
                const record = dayRecords[s.id] || {};
                return {
                    'STT': i + 1,
                    'H·ªç v√† t√™n': s.name,
                    'L·ªõp': s.class,
                    'Gi·ªõi t√≠nh': s.gender,
                    'Ng√†y sinh': formatDate(s.birthDate),
                    'Lo·∫°i h·ªçc sinh': s.type,
                    'Tr·∫°ng th√°i S√°ng': getStatusText(record.morning?.status || 'present', true),
                    'TG S√°ng': formatTimestamp(record.morning?.timestamp),
                    'Tr·∫°ng th√°i Chi·ªÅu': getStatusText(record.afternoon?.status || 'present', true),
                    'TG Chi·ªÅu': formatTimestamp(record.afternoon?.timestamp),
                };
            });
            const ws = XLSX.utils.json_to_sheet(data);
            ws['!cols'] = [{ wch: 5 }, { wch: 25 }, { wch: 10 }, { wch: 10 }, { wch: 12 }, { wch: 15 }, { wch: 15 }, { wch: 12 }, { wch: 15 }, { wch: 12 }];
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, `DiemDanh_${selectedDate}`);
            XLSX.writeFile(wb, `Diem_danh_${selectedDate}.xlsx`);
        };

        window.exportDailyStatsToExcel = function() {
            if (!checkAdminPassword()) return;
            const selectedDate = document.getElementById('dailyStatsDate').value;
            const selectedClass = document.getElementById('dailyStatsClassFilter').value;
            let filteredStudents = (selectedClass !== 'all') ? window.students.filter(s => s.class === selectedClass) : window.students;
            
            const stats = calculateDayStats(window.attendanceRecords[selectedDate] || {}, filteredStudents);
            const wb = XLSX.utils.book_new();

            const summaryData = [
                ["Th·ªëng k√™ ng√†y", formatDate(selectedDate)], ["L·ªõp", selectedClass === 'all' ? 'T·∫•t c·∫£' : selectedClass], [],
                ["H·∫°ng m·ª•c", "S√°ng", "Chi·ªÅu"],
                ["V·∫Øng KP", stats.morning.absent_unexcused, stats.afternoon.absent_unexcused],
                ["V·∫Øng CP", stats.morning.absent_excused, stats.afternoon.absent_excused],
                ["B√°n tr√∫ v·∫Øng KP", stats.morning.boarding_absent_unexcused, stats.afternoon.boarding_absent_unexcused],
                ["B√°n tr√∫ v·∫Øng CP", stats.morning.boarding_absent_excused, stats.afternoon.boarding_absent_excused],
                ["ƒêi mu·ªôn", stats.morning.late, stats.afternoon.late],
                ["T·ªïng v·∫Øng", stats.morning.absent_total, stats.afternoon.absent_total]
            ];
            const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
            ws1['!cols'] = [{ wch: 25 }, { wch: 10 }, { wch: 10 }];
            XLSX.utils.book_append_sheet(wb, ws1, "T·ªïng quan");

            const dayRecords = window.attendanceRecords[selectedDate] || {};
            const detailData = filteredStudents.map((s, i) => ({
                'STT': i + 1,
                'H·ªç v√† t√™n': s.name,
                'L·ªõp': s.class,
                'Gi·ªõi t√≠nh': s.gender,
                'Ng√†y sinh': formatDate(s.birthDate),
                'Lo·∫°i h·ªçc sinh': s.type,
                'Tr·∫°ng th√°i S√°ng': getStatusText(dayRecords[s.id]?.morning?.status || 'present', true),
                'Tr·∫°ng th√°i Chi·ªÅu': getStatusText(dayRecords[s.id]?.afternoon?.status || 'present', true)
            }));
            const ws2 = XLSX.utils.json_to_sheet(detailData);
            ws2['!cols'] = [{ wch: 5 }, { wch: 25 }, { wch: 10 }, { wch: 10 }, { wch: 12 }, { wch: 15 }, { wch: 15 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, ws2, "Chi ti·∫øt");
            XLSX.writeFile(wb, `Thong_ke_ngay_${selectedDate}_${selectedClass}.xlsx`);
        };
        
        window.exportMonthlyStatsToExcel = function() {
            if (!checkAdminPassword()) return;
            const selectedMonth = document.getElementById('monthlyStatsDate').value;
            const [year, month] = selectedMonth.split('-');
            const stats = calculateMonthlyStats(year, month);
            const wb = XLSX.utils.book_new();

            const summaryData = [
                ["Th·ªëng k√™ th√°ng", `${month}/${year}`], [],
                ["H·∫°ng m·ª•c", "T·ªïng s·ªë bu·ªïi"],
                ["T·ªïng bu·ªïi v·∫Øng KP S√°ng", stats.totals.morning.absent_unexcused],
                ["T·ªïng bu·ªïi v·∫Øng CP S√°ng", stats.totals.morning.absent_excused],
                ["T·ªïng bu·ªïi BT v·∫Øng KP S√°ng", stats.totals.morning.boarding_absent_unexcused],
                ["T·ªïng bu·ªïi BT v·∫Øng CP S√°ng", stats.totals.morning.boarding_absent_excused],
                ["T·ªïng bu·ªïi v·∫Øng KP Chi·ªÅu", stats.totals.afternoon.absent_unexcused],
                ["T·ªïng bu·ªïi v·∫Øng CP Chi·ªÅu", stats.totals.afternoon.absent_excused],
                ["T·ªïng bu·ªïi BT v·∫Øng KP Chi·ªÅu", stats.totals.afternoon.boarding_absent_unexcused],
                ["T·ªïng bu·ªïi BT v·∫Øng CP Chi·ªÅu", stats.totals.afternoon.boarding_absent_excused]
            ];
            const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
            ws1['!cols'] = [{ wch: 35 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, ws1, "T·ªïng quan th√°ng");

            const detailData = Object.values(stats.studentData).map((data, i) => ({
                'STT': i + 1,
                'H·ªç v√† t√™n': data.student.name,
                'L·ªõp': data.student.class,
                'Gi·ªõi t√≠nh': data.student.gender,
                'Ng√†y sinh': formatDate(data.student.birthDate),
                'Lo·∫°i h·ªçc sinh': data.student.type,
                'S·ªë bu·ªïi c√≥ m·∫∑t': data.present,
                'S·ªë bu·ªïi ƒëi mu·ªôn': data.late,
                'S·ªë bu·ªïi v·∫Øng KP': data.absent_unexcused,
                'S·ªë bu·ªïi v·∫Øng CP': data.absent_excused
            }));
            const ws2 = XLSX.utils.json_to_sheet(detailData);
            ws2['!cols'] = [{ wch: 5 }, { wch: 25 }, { wch: 10 }, { wch: 10 }, { wch: 12 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, ws2, "Chi ti·∫øt th√°ng");
            XLSX.writeFile(wb, `Thong_ke_thang_${month}_${year}.xlsx`);
        };
    </script>
</body>
</html>

