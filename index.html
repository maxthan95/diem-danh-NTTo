<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ph·∫ßn m·ªÅm ƒëi·ªÉm danh h·ªçc sinh (C·ªông t√°c) - N√¢ng c·∫•p S√°ng/Chi·ªÅu</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* General styling */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 10px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }

        /* Header */
        .header { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; text-align: center; position: relative; }
        .header h1 { font-size: 2rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { font-size: 1rem; opacity: 0.9; }
        #app-id-container { background: rgba(0, 0, 0, 0.2); padding: 8px 15px; border-radius: 20px; font-size: 0.9rem; margin-top: 15px; display: inline-block; border: 1px solid rgba(255, 255, 255, 0.3); }
        #app-id-container span { font-weight: bold; color: #fff; }

        /* Tabs */
        .tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #e9ecef; flex-wrap: wrap; }
        .tab { flex: 1 1 auto; padding: 15px 10px; background: none; border: none; cursor: pointer; font-size: 0.9rem; font-weight: 600; color: #6c757d; transition: all 0.3s ease; text-align: center; }
        .tab.active { background: white; color: #4facfe; border-bottom: 3px solid #4facfe; }
        .tab:hover:not(.active) { background: #e9ecef; color: #495057; }
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }

        /* Forms and Buttons */
        .form-section { background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 25px; border-left: 4px solid #4facfe; }
        .form-section h3 { color: #495057; margin-bottom: 20px; font-size: 1.3rem; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; color: #495057; margin-bottom: 8px; font-size: 0.95rem; }
        .form-group input, .form-group select { padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem; transition: all 0.3s ease; background: white; width: 100%; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #4facfe; box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1); }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; width: 100%; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3); }

        /* Student List */
        .student-list { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .student-list-header { display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 15px 20px; }
        .student-list-header h3 { margin: 0; font-size: 1.3rem; }
        .student-list-header .header-controls { display: flex; align-items: center; gap: 15px; }
        .student-item { padding: 15px; border-bottom: 1px solid #e9ecef; display: grid; grid-template-columns: auto 1fr; gap: 15px; align-items: center; }
        .student-item:hover { background: #f8f9fa; }
        .student-item-content { display: grid; grid-template-columns: 1fr; gap: 15px; align-items: center; }
        .student-info { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .student-detail { display: flex; flex-direction: column; }
        .student-detail strong { color: #495057; font-size: 0.9rem; margin-bottom: 5px; }
        .student-detail span { color: #6c757d; font-size: 1rem; }

        /* Attendance */
        .attendance-controls { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        .attendance-controls .btn { flex: 1 1 100px; }
        .attendance-status { padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; font-weight: 600; border: 2px solid transparent; }
        .status-present { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .status-late { background: #fff3cd; color: #856404; border-color: #ffeaa7; }
        .status-absent-unexcused { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .status-absent-excused { background: #e2e3e5; color: #383d41; border-color: #d6d8db; }
        .session-selector { display: flex; gap: 10px; margin-bottom: 15px; justify-content: center; }
        .session-selector .btn { width: auto; flex-grow: 1; }
        .session-selector .btn.active { background: #007bff; color: white; box-shadow: 0 0 10px rgba(0,123,255,0.4); }

        /* Quick Actions & Stats */
        .quick-actions { background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 25px; display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; }
        .quick-actions .btn { flex: 1 1 150px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stats-card { background: white; border-radius: 10px; padding: 20px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-left: 4px solid #4facfe; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .stats-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.15); }
        .stats-card.active-filter { border-left-width: 6px; border-left-color: #007bff; }
        .stats-card h4 { color: #495057; margin-bottom: 10px; font-size: 0.9rem; }
        .stats-card .number { font-size: 2rem; font-weight: bold; color: #4facfe; margin-bottom: 5px; }
        .date-filter { background: white; border-radius: 10px; padding: 20px; margin-bottom: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .filter-row { display: grid; grid-template-columns: 1fr; gap: 15px; align-items: end; }
        .empty-state { text-align: center; padding: 60px 20px; color: #6c757d; }
        
        /* Responsive */
        @media (min-width: 768px) {
            body { padding: 20px; }
            .header h1 { font-size: 2.5rem; }
            .header p { font-size: 1.1rem; }
            .tab { font-size: 1rem; padding: 15px 20px; }
            .tab-content, .form-section { padding: 30px; }
            .btn { width: auto; }
            .filter-row { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
            .student-item-content { grid-template-columns: 1fr auto; gap: 20px; }
            .student-info { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
            .attendance-controls { justify-content: flex-end; }
            .attendance-controls .btn { flex-grow: 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Ph·∫ßn m·ªÅm ƒëi·ªÉm danh h·ªçc sinh</h1>
            <p>C·ªông t√°c ƒëi·ªÉm danh th·ªùi gian th·ª±c (S√°ng/Chi·ªÅu)</p>
            <div id="app-id-container">M√£ chia s·∫ª (App ID): <span id="appIdDisplay">ƒêang t·∫£i...</span></div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('students')">üë• Qu·∫£n l√Ω h·ªçc sinh</button>
            <button class="tab" onclick="showTab('attendance')">üìù ƒêi·ªÉm danh</button>
            <button class="tab" onclick="showTab('daily-stats')">üìä Th·ªëng k√™ h√†ng ng√†y</button>
            <button class="tab" onclick="showTab('monthly-stats')">üìà Th·ªëng k√™ h√†ng th√°ng</button>
        </div>

        <div id="students" class="tab-content active">
            </div>

        <div id="attendance" class="tab-content">
            <div class="quick-actions">
                <button class="btn btn-success" onclick="markAllPresent()">‚úÖ T·∫•t c·∫£ c√≥ m·∫∑t</button>
                <button class="btn btn-info" onclick="exportAttendanceToExcel()">üìÅ Xu·∫•t Excel</button>
            </div>

            <div class="date-filter">
                <h4>üìÖ L·ªçc v√† ƒëi·ªÉm danh</h4>
                <div class="filter-row">
                    <div class="form-group">
                        <label for="attendanceDate">Ch·ªçn ng√†y ƒëi·ªÉm danh</label>
                        <input type="date" id="attendanceDate" onchange="loadAttendanceForDate()">
                    </div>
                    <div class="form-group">
                        <label for="classFilter">Ch·ªçn l·ªõp</label>
                        <select id="classFilter" onchange="loadAttendanceForDate()"></select>
                    </div>
                </div>
                <div class="session-selector">
                    <button id="session-morning" class="btn active" onclick="selectSession('morning')">Bu·ªïi S√°ng</button>
                    <button id="session-afternoon" class="btn" onclick="selectSession('afternoon')">Bu·ªïi Chi·ªÅu</button>
                </div>
            </div>

            <div class="student-list">
                <h3 id="attendanceListTitle">üë®‚Äçüéì ƒêi·ªÉm danh h·ªçc sinh</h3>
                <div id="attendanceList"></div>
            </div>
        </div>

        <div id="daily-stats" class="tab-content">
            </div>

        <div id="monthly-stats" class="tab-content">
            </div>
    </div>

    <script type="module">
        // Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Global variables and Firebase initialization
        const appId = 'diem-danh-NTTo';
        const firebaseConfig = {
    		apiKey: "AIzaSyBbNvKLgj8QdM22rqxnS65cJGSF5wNUIJE",
    		authDomain: "diem-danh-20xx.firebaseapp.com",
    		projectId: "diem-danh-20xx",
    		storageBucket: "diem-danh-20xx.firebasestorage.app",
    		messagingSenderId: "474588160188",
    		appId: "1:474588160188:web:37a1b187369ff47e56f0b9",
    		measurementId: "G-CYHW7NZKGM"
  		};
        let db, auth, dataDocRef;
        window.students = [];
        window.attendanceRecords = {};

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            document.getElementById('appIdDisplay').textContent = appId;
        } catch (e) {
            console.error("Error initializing Firebase:", e);
            alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn c∆° s·ªü d·ªØ li·ªáu.");
        }

        async function initializeFirebase() {
            try {
                await signInAnonymously(auth);
                dataDocRef = doc(db, "artifacts", appId, "public", "data", "attendance", "mainDoc");
                onSnapshot(dataDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        window.students = data.students || [];
                        window.attendanceRecords = data.attendanceRecords || {};
                    }
                    updateAllUI();
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                alert("Kh√¥ng th·ªÉ kh·ªüi t·∫°o ·ª©ng d·ª•ng.");
            }
        }
        
        initializeFirebase();

        function updateAllUI() {
            // Populate UI functions
            window.loadAttendanceForDate();
        }

        let saveTimeout = null;
        window.autoSave = function() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => saveData(), 2000);
        }

        async function saveData() {
            if (!dataDocRef) return;
            const dataToSave = {
                students: window.students,
                attendanceRecords: window.attendanceRecords,
            };
            try {
                await setDoc(dataDocRef, dataToSave);
            } catch (error) {
                console.error("Error saving data:", error);
            }
        }
    </script>
    
    <script>
        // --- GLOBAL UI STATE ---
        let currentSession = 'morning'; // 'morning' or 'afternoon'

        window.onload = function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendanceDate').value = today;
            // Other onload initializations
        };

        // --- TAB & SESSION MANAGEMENT ---
        window.showTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        window.selectSession = function(session) {
            currentSession = session;
            document.getElementById('session-morning').classList.toggle('active', session === 'morning');
            document.getElementById('session-afternoon').classList.toggle('active', session === 'afternoon');
            loadAttendanceForDate();
        }

        // --- ATTENDANCE LOGIC (MODIFIED) ---
        window.loadAttendanceForDate = function() {
            const selectedDate = document.getElementById('attendanceDate').value;
            const selectedClass = document.getElementById('classFilter').value;
            const container = document.getElementById('attendanceList');
            
            let filteredStudents = window.students;
            if (selectedClass && selectedClass !== 'all') {
                filteredStudents = window.students.filter(s => s.class === selectedClass);
            }

            const dayRecords = window.attendanceRecords[selectedDate] || {};

            container.innerHTML = filteredStudents.map(student => {
                const studentRecords = dayRecords[student.id] || {};
                const status = studentRecords[currentSession]?.status || 'present'; // Get status for the current session

                return `
                    <div class="student-item">
                        <div class="student-item-content">
                            <div class="student-info">
                                <div class="student-detail"><strong>H·ªç v√† t√™n:</strong><span>${student.name}</span></div>
                                <div class="student-detail"><strong>L·ªõp:</strong><span>${student.class}</span></div>
                                <div class="student-detail"><strong>Tr·∫°ng th√°i (${currentSession === 'morning' ? 'S√°ng' : 'Chi·ªÅu'}):</strong>
                                    <span class="attendance-status ${getStatusClass(status)}">${getStatusText(status)}</span>
                                </div>
                            </div>
                            <div class="attendance-controls">
                                <button class="btn" onclick="markAttendance(${student.id}, 'present')">‚úÖ C√≥ m·∫∑t</button>
                                <button class="btn" onclick="markAttendance(${student.id}, 'late')">‚è∞ Mu·ªôn</button>
                                <button class="btn" onclick="markAttendance(${student.id}, 'absent_excused')">üìã V·∫Øng CP</button>
                                <button class="btn" onclick="markAttendance(${student.id}, 'absent_unexcused')">‚ùå V·∫Øng KP</button>
                            </div>
                        </div>
                    </div>`;
            }).join('');
        }

        window.markAttendance = function(studentId, status) {
            const selectedDate = document.getElementById('attendanceDate').value;
            if (!window.attendanceRecords[selectedDate]) {
                window.attendanceRecords[selectedDate] = {};
            }
            if (!window.attendanceRecords[selectedDate][studentId]) {
                window.attendanceRecords[selectedDate][studentId] = {};
            }
            // MODIFIED: Save status to the selected session
            window.attendanceRecords[selectedDate][studentId][currentSession] = {
                status: status,
                timestamp: new Date().toISOString()
            };
            autoSave();
            loadAttendanceForDate(); // Refresh list to show change
        }
        
        window.markAllPresent = function() {
            const selectedDate = document.getElementById('attendanceDate').value;
            const selectedClass = document.getElementById('classFilter').value;
            let studentsToMark = window.students;
            if (selectedClass && selectedClass !== 'all') {
                studentsToMark = window.students.filter(s => s.class === selectedClass);
            }
            
            if (!window.attendanceRecords[selectedDate]) {
                window.attendanceRecords[selectedDate] = {};
            }
            const timestamp = new Date().toISOString();
            studentsToMark.forEach(student => {
                 if (!window.attendanceRecords[selectedDate][student.id]) {
                    window.attendanceRecords[selectedDate][student.id] = {};
                }
                window.attendanceRecords[selectedDate][student.id][currentSession] = {
                    status: 'present',
                    timestamp: timestamp
                };
            });
            autoSave();
            alert(`ƒê√£ ƒëi·ªÉm danh c√≥ m·∫∑t cho ${studentsToMark.length} h·ªçc sinh (Bu·ªïi ${currentSession === 'morning' ? 'S√°ng' : 'Chi·ªÅu'}).`);
            loadAttendanceForDate();
        }

        // --- UTILITY FUNCTIONS ---
        function getStatusClass(status) {
            return { 
                present: 'status-present', 
                late: 'status-late', 
                absent_unexcused: 'status-absent-unexcused',
                absent_excused: 'status-absent-excused'
            }[status] || 'status-present';
        }

        function getStatusText(status) {
            return { 
                present: '‚úÖ C√≥ m·∫∑t', 
                late: '‚è∞ Mu·ªôn', 
                absent_unexcused: '‚ùå V·∫Øng KP',
                absent_excused: 'üìã V·∫Øng CP'
            }[status] || '‚úÖ C√≥ m·∫∑t';
        }
    </script>
</body>
</html>
